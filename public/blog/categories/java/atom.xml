<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: java | mishadoff thoughts]]></title>
  <link href="http://mishadoff.github.io/blog/categories/java/atom.xml" rel="self"/>
  <link href="http://mishadoff.github.io/"/>
  <updated>2014-08-07T20:02:54+03:00</updated>
  <id>http://mishadoff.github.io/</id>
  <author>
    <name><![CDATA[mishadoff]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Effective Java]]></title>
    <link href="http://mishadoff.github.io/blog/effective-java/"/>
    <updated>2014-08-07T13:54:00+03:00</updated>
    <id>http://mishadoff.github.io/blog/effective-java</id>
    <content type="html"><![CDATA[<p>Recently, I’ve re-read awesome java book
<a href="http://www.amazon.com/Effective-Java-Edition-Joshua-Bloch/dp/0321356683">Effective Java</a>
by Joshua Bloch. The book contains 78 <em>independent</em> items, discussing various aspects of programming in java. Something like <em>mini-design patterns</em> with emphasis on their pros and cons.</p>

<p>Few notes from each item as a refresher.</p>

<!-- more -->

<h3 id="item-1-consider-static-factory-methods-instead-of-constructors">Item 1: Consider static factory methods instead of constructors</h3>

<ul>
  <li>Static factory methods have more informative names than constructors</li>
  <li>Same parameters list could be applied</li>
  <li>Not required to create new objects, could return cached instance</li>
  <li>Static factory methods could return object subtype</li>
  <li>Reduced verbosity for generics due to type inference</li>
  <li>Classes without public/private constructor can’t be subclassed, but it is good, because it enforces to “favor composition over inheritance”</li>
  <li>Hard to distinguish from other static methods. To avoid confusion use common names like <code>newIntance</code>, <code>valueOf</code>, etc.</li>
</ul>

<h3 id="item-2-consider-a-builder-when-faced-with-many-constructor-parameters">Item 2: Consider a builder when faced with many constructor parameters</h3>

<ul>
  <li><strong>Telescope Constructor</strong> causes verbosity</li>
  <li><strong>JavaBeans</strong> may cause inconsistent state, no possibbility to make a class immutable</li>
  <li><strong>Builder Pattern</strong> is flexible and right way to handle optional parameters</li>
</ul>

<h3 id="item-3-enforce-the-singleton-property-with-a-private-constructor-or-an-enum-type">Item 3: Enforce the singleton property with a private constructor or an enum type</h3>

<p><em>Caution:</em> Discussed singleton <strong>without</strong> lazy initialization</p>

<ul>
  <li>Throw an exception in a private constructor to avoid reflection call to constructor</li>
  <li>If standard serialization is needed make all fields transient and override <code>readResolve</code> method</li>
  <li>Best way to use single element enum as a singleton</li>
</ul>

<p><code>java
enum Singleton {
  INSTANCE
}
</code></p>

<h3 id="item-4-enforce-noninstantiability-with-a-private-constructor">Item 4: Enforce noninstantiability with a private constructor</h3>

<ul>
  <li>Include a single private constructor to a class to prevent it from instantiation</li>
  <li>Throw an exception in constructor if it is called</li>
  <li>Almost always used technique for utility classes</li>
</ul>

<h3 id="item-5-avoid-creating-unnecessary-objects">Item 5: Avoid creating unnecessary objects</h3>

<ul>
  <li><code>"hello"</code> is better than <code>new String("hello")</code></li>
  <li><code>Boolean.valueOf("true")</code> is better than <code>new Boolean("true")</code></li>
  <li>Immutable objects could be reused for free</li>
  <li>Mutable objects could be reused if you <em>really</em> sure, they won’t be modified</li>
  <li>prefer primitives to boxed primitives</li>
  <li>watch out for hidden autoboxing</li>
</ul>

<h3 id="item-6-eliminate-obsolete-object-references">Item 6: Eliminate obsolete object references</h3>

<ul>
  <li>Garbage collector is not savior from memory leaks</li>
  <li>Nullify obsolete references</li>
  <li>Invalidate cache periodically</li>
  <li>Deregister outdated listeners and callbacks</li>
</ul>

<h3 id="item-7-avoid-finalizers">Item 7: Avoid finalizers</h3>

<ul>
  <li>Finalizers are not destructors</li>
  <li>No guarantee finalizers will be executed promptly</li>
  <li>No guarantee finalizers will be executed at all</li>
  <li><code>System.gc</code> just a hint, not a gc call</li>
  <li>Finalizers cause <strong>severe</strong> performance penalty</li>
  <li>Use own explicit methods for finalization like <code>close()</code></li>
</ul>

<h3 id="item-8-obey-the-general-contract-when-overriding-equals">Item 8: Obey the general contract when overriding equals</h3>

<ul>
  <li>Overridden <code>equals</code> should follow <em>equivalence relation</em>
    <ul>
      <li>Reflexive, <code>x.equals(x) == true</code></li>
      <li>Symmetric, <code>x.equals(y) == y.equals(x)</code></li>
      <li>Transitive, <code>x.equals(y) and y.equals(z) == x.equals(z)</code></li>
      <li>Consistent, consequent calls <code>x.equals(y)</code> should produce the same value</li>
      <li><code>x.equals(null) == false</code> if <code>x</code> not null</li>
    </ul>
  </li>
  <li>There is no way to extend an instantiable class and add a value component while preserving the equals contract</li>
  <li>Do not write an equals method that depends on unreliable resources. This was discussed at the <a href="/blog/java-magic-part-1-java-dot-net-dot-url/">Java Magic: Part I</a></li>
  <li>Always override <code>hashCode</code> when you override <code>equals</code></li>
  <li>Don’t substitute param type in <code>equals</code>, that cause method <strong>overload</strong> instead of <strong>override</strong>.
Use <code>@Override</code> annotation to be safe.</li>
</ul>

<h3 id="item-9-always-override-hashcode-when-you-override-equals">Item 9: Always override hashCode when you override equals</h3>

<ul>
  <li>Equal objects must have equal hashcodes</li>
  <li>Unequal objects could have equal hashcodes</li>
  <li>Missing <code>hashCode</code> implementation breaks functionality of hash-based collections</li>
  <li>The worst possible legal hash function <code>return 42</code></li>
  <li>Bad hashcode could degrade performance in hash-based collections</li>
  <li>Hashcode could be cached for immutable classes</li>
  <li>Do not try to develop your own <code>state-of-the-art</code> hash function unless you are a matematician</li>
</ul>

<h3 id="item-10-always-override-tostring">Item 10: Always override toString</h3>

<ul>
  <li>Actually, not required</li>
  <li>Easier to inspect objects</li>
  <li>Include all needed info to <code>toString</code></li>
  <li>Document what exactly <code>toString</code> returns and in which format</li>
  <li>Provide programmatic access to all of the information contained in the value returned by <code>toString</code></li>
</ul>

<h3 id="item-11-override-clone-judiciously">Item 11: Override clone judiciously</h3>

<ul>
  <li><code>Cloneable</code> is broken</li>
  <li>If you override the <code>clone</code> method in a nonfinal class, you should return an object obtained by invoking <code>super.clone</code></li>
  <li>Class that implements <code>Cloneable</code> is expected to provide a properly functioning public <code>clone</code> method</li>
  <li><code>clone</code> should not corrupt original object</li>
  <li>Pay attention to <em>deep</em> and <em>shallow</em> copy</li>
  <li>Provide copy constructor or copy factory instead of implementing <code>clone</code></li>
</ul>

<h3 id="item-12-consider-implementing-comparable">Item 12: Consider implementing Comparable</h3>

<ul>
  <li>Implementing <code>Comparable</code> indicates that objects have natural ordering</li>
  <li><code>Comparable</code> allow to use your class in many generic algorithms: search, sorting, etc.</li>
  <li><code>compareTo</code> should be consistent with <code>equals</code></li>
  <li>Implement <code>compareTo</code> that returns <code>-1</code>, <code>0</code> and <code>1</code> and do not cause integer overflow</li>
  <li>For non-natural ordering or inability to implement <code>Comparable</code> use <code>Comparator</code></li>
</ul>

<h3 id="item-13-minimize-the-accessibility-of-classes-and-members">Item 13: Minimize the accessibility of classes and members</h3>

<ul>
  <li>Make each class or member as inaccessible as possible</li>
  <li>If a package-private top-level class is used by only one class, consider making the top-level class a private nested class of the sole class that uses it</li>
  <li>If a method overrides a superclass method, it is not permitted to have a lower access level in the subclass than it does in the superclass</li>
  <li>Instance fields should never be public</li>
  <li>Classes with public mutable fields are not thread-safe</li>
  <li>public static final arrays are mutable</li>
</ul>

<h3 id="item-14-in-public-classes-use-accessor-methods-not-public-fields">Item 14: In public classes, use accessor methods, not public fields</h3>

<ul>
  <li>public fields are acceptable if class is not public</li>
  <li>if a class is accessible outside its package, provide accessor methods</li>
</ul>

<h3 id="item-15-minimize-mutability">Item 15: Minimize mutability</h3>

<ul>
  <li>Immutable classes are easier to design, implement and use. They are less error-prone and more secure</li>
  <li>To make a class immutable follow the rules
    <ul>
      <li>Don’t provide any mutators</li>
      <li>Ensure that the class can’t be extended</li>
      <li>Make all fields <code>final</code></li>
      <li>Make all fields <code>private</code></li>
      <li>Ensure exclusive access to any mutable components. Return defensive copies</li>
    </ul>
  </li>
  <li>Immutable objects are thread-safe</li>
  <li>Immutable objects are shared freely</li>
  <li>Not only can you share immutable objects, but you can share their internals</li>
  <li>The only real disadvantage of immutable classes is that they require a separate object for each distinct value</li>
  <li>Classes should be immutable unless there’s a very good reason to make them mutable.</li>
  <li>If a class cannot be made immutable, limit its mutability as much as possible.</li>
  <li>Make every field final unless there is a compelling reason to make it nonfinal</li>
</ul>

<h3 id="item-16-favor-composition-over-inheritance">Item 16: Favor composition over inheritance</h3>

<ul>
  <li>Unlike method invocation, inheritance violates encapsulation</li>
  <li>Subclasses depend on their superclasses, which could be changed and as result broken functionality in subclasses</li>
  <li>Use composition and forwarding instead of inheritance, especially if an appropriate interface to implement a wrapper class exists.</li>
  <li>Use inheritance when class is designed for inheritance</li>
</ul>

<h3 id="item-17-design-and-document-for-inheritance-or-else-prohibit-it">Item 17: Design and document for inheritance or else prohibit it</h3>

<ul>
  <li>Class must document its self-use of overridable methods</li>
  <li>Good API documentation <em>for inheritance</em> should describe what a given method does and how it does it.</li>
  <li>The only way to test a class designed for inheritance is to write subclasses</li>
  <li>Constructors must not invoke overridable methods</li>
  <li>If supperclass implements <code>Cloneable</code> or <code>Serializable</code> neither <code>clone</code> nor <code>readObject</code> may invoke an overridable method, directly or indirectly</li>
  <li>Prohibit subclassing in classes that are not designed and documented to be safely subclassed</li>
  <li>Prohibit subclassing by making class final</li>
</ul>

<h3 id="item-18-prefer-interfaces-to-abstract-classes">Item 18: Prefer interfaces to abstract classes</h3>

<ul>
  <li>Existing classes can be easily retrofitted to implement a new interface</li>
  <li>Interfaces are ideal for defining mixins</li>
  <li>Interfaces allow the construction of nonhierarchical type frameworks</li>
  <li>Interfaces enable safe, powerful functionality enhancements via wrapper classes</li>
  <li>Abstract classes are useful for sceletal implementation</li>
  <li>You could safely add a method to abstract class with default implementation (<em>the same applies to interfaces since Java 8 release, with help of default methods</em>)</li>
  <li>Once an interface is released and widely implemented, it is almost impossible to change</li>
</ul>

<h3 id="item-19-use-interfaces-only-to-define-types">Item 19: Use interfaces only to define types</h3>

<ul>
  <li>Do not use interface for defining constants</li>
  <li>If in a future release the class is modified so that it no longer needs to use the constants, it still must implement the interface to ensure binary compatibility</li>
  <li>If a nonfinal class implements a constant interface, all of its subclasses will have their namespaces polluted by the constants in the interface</li>
  <li>Add constant to class if they are strongly tied to it</li>
  <li>Make constants as enum or noninstantiable utility classes</li>
</ul>

<h3 id="item-20-prefer-class-hierarchies-to-tagged-classes">Item 20: Prefer class hierarchies to tagged classes</h3>

<ul>
  <li>Tagged class use internal state to indicate its type</li>
  <li>Tagged classes are verbose, error-prone, and memory inefficient</li>
  <li>Hierarchy classes provide more compile time checks</li>
</ul>

<h3 id="item-21-use-function-objects-to-represent-strategies">Item 21: Use function objects to represent strategies</h3>

<ul>
  <li>Function objects are simulate functions in OOP</li>
  <li>Function objects should be stateless</li>
  <li>Primary use of function objects is to implement the Strategy pattern</li>
</ul>

<h3 id="item-22-favor-static-member-classes-over-nonstatic">Item 22: Favor static member classes over nonstatic</h3>

<ul>
  <li>A nested class should exist only to serve its enclosing class</li>
  <li>There are four kinds of nested classes
    <ul>
      <li>Static member classes</li>
      <li>Nonstatic member classes</li>
      <li>Anonymous classes</li>
      <li>Local classes</li>
    </ul>
  </li>
  <li>Static member classes could exist without enclosing <em>instance</em></li>
  <li>If you declare a member class that does not require access to an enclosing instance, always put the static modifier in its declaration</li>
  <li>Anonymous classes could be instantiated <em>only</em> at the point they are declared</li>
  <li>Anonymous classes have enclosing instances if they are defined ina nonstatic context</li>
  <li>Local classes can be declared anywhere a local variable can be declared and have the same scoping rules</li>
</ul>

<h3 id="item-23-dont-use-raw-types-in-new-code">Item 23: Don’t use raw types in new code</h3>

<ul>
  <li>Generic types provide compile-time checking for incompatible types</li>
  <li>Not needed manual cast to type when you retrieve element from collections</li>
  <li>Raw types exists only for backward compatibility</li>
  <li>You lose type safety if you use a raw type</li>
  <li>Raw types could be used with <code>instanceof</code> operator</li>
</ul>

<h3 id="item-24-eliminate-unchecked-warnings">Item 24: Eliminate unchecked warnings</h3>

<ul>
  <li>Eliminate every unchecked warning that you can, that means your code is typesafe</li>
  <li>Use <code>@SuppressWarnings("unchecked")</code> only if you can prove the code is typesafe</li>
  <li>Always use the <code>@SuppressWarnings</code> annotation on the smallest scope possible</li>
  <li>Every time you use an <code>@SuppressWarnings</code> annotation, add a comment saying why it’s safe to do so</li>
  <li>Every unchecked warning represents the potential for a <code>ClassCastException</code> at runtime. Do not ignore them blindly</li>
</ul>

<h3 id="item-25-prefer-lists-to-arrays">Item 25: Prefer lists to arrays</h3>

<ul>
  <li>Arrays are covariant (if <code>Sub</code> is subtype of <code>Super</code>, then <code>Sub[]</code> is a subtype of <code>Super[]</code>)</li>
  <li>Generics are invariant (<code>List&lt;Sub&gt;</code> is not a subtype of <code>List&lt;Super&gt;</code>)</li>
  <li>Arrays are reified (enforce their element types at runtime)</li>
  <li>Generics are non-reified and implemented by erasure (enforce types at a compile time, but erased at a runtime)</li>
  <li>Generic array creation errors at compile time (<code>List&lt;E&gt;[]</code>)</li>
  <li>Array of non-reified types can not be created</li>
</ul>

<h3 id="item-26-favor-generic-types">Item 26: Favor generic types</h3>

<ul>
  <li><code>Object</code> type in collections are good candidate to replace with generic types</li>
  <li><code>new E[]</code> cause compile time error, use <code>(E[]) new Object[]</code> instead</li>
</ul>

<h3 id="item-27-favor-generic-methods">Item 27: Favor generic methods</h3>

<ul>
  <li>Generic type parameter list, which declares the type parameter, goes between the method’s modifiers and its return type (<code>public static &lt;T&gt; void method()</code>)</li>
  <li>Generic methods could infere type of arguments</li>
</ul>

<h3 id="item-28-use-bounded-wildcards-to-increase-api-flexibility">Item 28: Use bounded wildcards to increase API flexibility</h3>

<ul>
  <li>Generics are invariant (<code>List&lt;Integer&gt;</code> is not a subtype of <code>List&lt;Number&gt;</code>)</li>
  <li>For maximum flexibility, use wildcard types on input parameters that represent producers or consumers</li>
  <li><strong>PECS</strong>: <strong>P</strong>roducer - <strong>E</strong>xtends , <strong>C</strong>onsumer - <strong>S</strong>uper</li>
  <li>Producer: <code>add(List&lt;? extends Number&gt;)</code></li>
  <li>Consumer: <code>get(List&lt;? super Number&gt;)</code></li>
  <li><code>Comparable</code> and <code>Comparator</code> are consumers</li>
  <li>Do not use wildcard types as return types, it would force use wildcards in the client code</li>
  <li>Use explicit types if compiler can’t infere them <code>Union&lt;Number&gt;.union()</code></li>
  <li>if a type parameter appears only once in a method declaration, replace it with a wildcard</li>
</ul>

<h3 id="item-29-consider-typesafe-heterogeneous-containers">Item 29: Consider typesafe heterogeneous containers</h3>

<ul>
  <li>Single-element containers could be parametrized (<code>ThreadLocal</code>, <code>AtomicReference</code>)</li>
  <li><code>String.class</code> is of type <code>Class&lt;String&gt;</code></li>
  <li>Typesafe heterogeneous container pattern  </li>
</ul>

<p><code>java
public class Favorites {
  public &lt;T&gt; void putFavorite(Class&lt;T&gt; type, T instance);
  public &lt;T&gt; T getFavorite(Class&lt;T&gt; type);
}
</code></p>

<ul>
  <li><code>String s = f.getFavorite(String.class)</code> is typesafe</li>
  <li>You can use <code>Class</code> objects as keys for typesafe heterogeneous containers.</li>
</ul>

<h3 id="item-30-use-enums-instead-of-int-constants">Item 30: Use enums instead of int constants</h3>

<ul>
  <li><em>int enum pattern</em> just a class with int constants</li>
  <li>Compiler won’t complain if you pass one int constant, where another expected</li>
  <li>If int constant number is changed, clients should be recompiled</li>
  <li>There is no easy way to translate int enum constants into printable strings</li>
  <li>There is no reliable way to obtain size or iterate over all the int enum constants in a group</li>
  <li><em>String enum pattern</em> is even worse</li>
  <li>String comparisons is expensive</li>
  <li>Error is string constant lead to runtime error</li>
  <li>Use enums!</li>
  <li>Each enum internally is <code>public static final int</code> field</li>
  <li>Enums provide compile-time type safety</li>
  <li>Enum types with identically named constants coexist peacefully because each type has its own namespace</li>
  <li>You can add or reorder constants in an enum type without recompiling clients</li>
  <li>Translate enums into printable strings by calling their <code>toString</code> method</li>
  <li>Enum types let you add arbitrary methods and fields and implement arbitrary interfaces</li>
  <li>If an enum is generally useful, it should be a top-level class; if its use is tied to a specific top-level class, it should be a member class of that top-level class</li>
  <li>To avoid switch on enum constant use <em>constant-specific method implementations</em>. Add abstract method to enum type, and override that method for each constant</li>
  <li>Enums have auto-generated methods <code>valueOf(String)</code>, <code>values()</code></li>
  <li>Switches on enums are good if you are client user of that enum</li>
</ul>

<h3 id="item-31-use-instance-fields-instead-of-ordinals">Item 31: Use instance fields instead of ordinals</h3>

<ul>
  <li>Every enum constant associated with int value via <code>ordinal()</code> method</li>
  <li>Reordering, adding or deleting enum constant cause problems if you depend on <code>ordinal()</code></li>
  <li>Use instance fields for enum (<code>APPLE(1)</code> instead of <code>APPLE.ordinal()</code>)</li>
</ul>

<h3 id="item-32-use-enumset-instead-of-bit-fields">Item 32: Use EnumSet instead of bit fields</h3>

<ul>
  <li><em>Bit int enum pattern</em> use int constants as a power of two (1,2,4,8,…) This lets you to perform union and intersection
with bitwise operations efficiently (<code>apply(STYLE_ITALIC | STYLE_BOLD)</code>)</li>
  <li>Hard to interpret bit int constants</li>
  <li>Hard to iterate over bit int constants</li>
  <li>Just because an enumerated type will be used in sets, there is no reason to represent it with bit fields</li>
  <li>Use <code>EnumSet</code> instead (<code>apply(EnumSet.of(Style.ITALIC, Style.BOLD))</code>)</li>
</ul>

<h3 id="item-33-use-enummap-instead-of-ordinal-indexing">Item 33: Use EnumMap instead of ordinal indexing</h3>

<ul>
  <li><code>ordinal()</code> for enums cause a lot of problems in array indexing</li>
  <li>ordinal indexing is not typesafe, may cause wrong associations or <code>IndexOutOfBoundsException</code></li>
  <li>Use <code>EnumMap.get(APPLE)</code> instead of <code>array[APPLE.ordinal()]</code></li>
  <li>If the relationship that you are representing is multidimensional, use <code>EnumMap&lt;..., EnumMap&lt;...&gt;&gt;</code></li>
</ul>

<h3 id="item-34-emulate-extensible-enums-with-interfaces">Item 34: Emulate extensible enums with interfaces</h3>

<ul>
  <li>There is no much useful use cases to extend enum functionality</li>
  <li><code>enum</code> could inplement interfaces, therefore allow extensibility</li>
  <li>While you cannot write an extensible enum type, you can emulate it by writing an interface to go with a basic enum type that implements the interface</li>
</ul>

<h3 id="item-35-prefer-annotations-to-naming-patterns">Item 35: Prefer annotations to naming patterns</h3>

<ul>
  <li>Prior to release 1.5, it was common to use naming patterns to indicate that some program elements demanded special treatment by a tool or framework (name test methods beginning with <code>test</code> for JUnit)</li>
  <li>No warning about typos, no control over program elements, ugly and fragile approach</li>
  <li>Annotations solve <em>naming patterns</em> problems</li>
  <li>Define annotation Test <code>public @interface Test</code></li>
  <li><code>@Retention(RetentionPolicy.RUNTIME)</code> meta-annotation indicates that Test annotations should be retained at runtime</li>
  <li><code>@Target(ElementType.METHOD)</code> meta-annotation indicates that the Test annotation is legal only on method declarations</li>
  <li>Process marker annotations <code>Method.isAnnotationPresent(Test.class)</code></li>
  <li>With the exception of toolsmiths, most programmers will have no need to define annotation types</li>
  <li>Consider using any annotations provided by your IDE or static analysis tools</li>
</ul>

<h3 id="item-36-consistently-use-the-override-annotation">Item 36: Consistently use the Override annotation</h3>

<ul>
  <li><code>@Override</code> can only be used on method declarations</li>
  <li><code>@Override</code> indicates that the annotated method declaration overrides a declaration in a supertype</li>
  <li><code>@Override</code> helps to catch tricky bugs (overloaded <code>equals</code>, <code>hashcode</code>)</li>
  <li>Use the <code>@Override</code> annotation on every method declaration that you believe to override a superclass declaration</li>
</ul>

<h3 id="item-37-use-marker-interfaces-to-define-types">Item 37: Use marker interfaces to define types</h3>

<ul>
  <li>A marker interface is an interface that contains no method declarations (<code>Serializable</code>, <code>Cloneable</code>)</li>
  <li>Marker interfaces are not marker annotations</li>
  <li>Marker interfaces define a type that is implemented by instances of the marked class; marker annotations do not</li>
  <li>Marker interfaces can be targeted more precisely by extending that interface</li>
  <li><code>Set</code> is <em>restricted marker interface</em>. It extends <code>Collection</code> but does not add new methods. It only refines contract for some methods to be more targeted.</li>
  <li>The chief advantage of marker annotations over marker interfaces is that it is possible to add more information to an annotation type after it is already in use, by adding one or more annotation type elements with defaults (Java8 default methods)</li>
  <li>If you find yourself writing a marker annotation type whose target is <code>ElementType.TYPE</code>, take the time to figure out whether it really should be an annotation type, or whether a marker interface would be more appropriate.</li>
</ul>

<h3 id="item-38-check-parameters-for-validity">Item 38: Check parameters for validity</h3>

<ul>
  <li>Detect errors and wrong values as soon as possible</li>
  <li>For public methods, use the Javadoc <code>@throws</code> tag to document the exception that will be thrown if a restriction on parameter values is violated</li>
  <li>nonpublic methods should generally check their parameters using assertions</li>
  <li>Unlike normal validity checks, they have no effect and essentially no cost unless you enable them, which you do by passing the <code>-ea</code> (or <code>-enableassertions</code>) flag to the java interpreter</li>
  <li>Do not use validity check if it is impractical or performed implicitly in the process of doing the computation</li>
</ul>

<h3 id="item-39-make-defensive-copies-when-needed">Item 39: Make defensive copies when needed</h3>

<ul>
  <li>You must program defensively, with the assumption that clients of your class will do their best to destroy its invariants</li>
  <li>If you return mutable reference from class, then class is also mutable</li>
  <li>To make immutable class, make a defensive copy of each mutable parameter</li>
  <li>Defensive copies are made before checking the validity of the parameters and the validity check is performed on the copies rather than on the originals (protect against changes from another thread, TOCTOU <em>time-of-check/time-of-use</em> attack) </li>
  <li>Do not use the clone method to make a defensive copy of a parameter whose type is subclassable by untrusted parties</li>
  <li>Defensive copying of parameters is not just for immutable classes, think twice before returning a reference</li>
  <li>Arrays are always mutable</li>
  <li>Defensive copying can have a performance penalty associated with it and isn’t always justified</li>
  <li>If the cost of the defensive copy would be prohibitive and the class trusts its clients not to modify the components inappropriately, then the defensive copy may be replaced by documentation outlining the client’s responsibility not to modify the affected components</li>
</ul>

<h3 id="item-40-design-method-signatures-carefully">Item 40: Design method signatures carefully</h3>

<ul>
  <li>Choose method names carefully</li>
  <li>Follow the code conventions</li>
  <li>Too many methods make a class difficult to learn, use, document, test, and maintain</li>
  <li>Avoid long parameter lists (four parameters or fewer)</li>
  <li>Use builder pattern, helper classes or helper methods to avoid long parameter lists</li>
  <li>For parameter types, favor interfaces over classes</li>
  <li>Prefer two-element enum types to boolean parameters</li>
</ul>

<h3 id="item-41-use-overloading-judiciously">Item 41: Use overloading judiciously</h3>

<ul>
  <li>The choice of which overloaded method to invoke is made at <strong>compile time</strong></li>
  <li>Selection among overloaded methods is static, while selection among overridden methods is dynamic</li>
  <li>A safe, conservative policy is never to export two overloadings with the same number of parameters</li>
  <li>The rules that determine which overloading is selected are extremely complex. They take up thirty-three pages in the language specification [JLS, 15.12.1-3]</li>
</ul>

<h3 id="item-42-use-varargs-judiciously">Item 42: Use varargs judiciously</h3>

<ul>
  <li>Use <code>call(int...)</code> when you need zero or more arguments</li>
  <li>Use <code>call(int, int...)</code> when you need one or more arguments</li>
  <li>Don’t use varargs for every method that has a final array parameter; use varargs only when a call really operates on a variable-length sequence of values</li>
  <li>Every invocation of a varargs method causes an array allocation and initialization</li>
  <li>Use overloaded methods with 2, 3, 4 params to cover most use-cases, otherwise use varargs</li>
</ul>

<h3 id="item-43-return-empty-arrays-or-collections-not-nulls">Item 43: Return empty arrays or collections, not nulls</h3>

<ul>
  <li>Do not return <code>null</code>s!</li>
  <li>Return empty collection (<code>Collections.emptyList()</code>), or zero-length array (<code>new int[0]</code>) instead of nulls</li>
  <li>Zero-length arrays and empty collections are not performance problems, because they are immutable and only one instance could be used</li>
</ul>

<h3 id="item-44-write-doc-comments-for-all-exposed-api-elements">Item 44: Write doc comments for all exposed API elements</h3>

<ul>
  <li>Document API with the <code>javadoc</code> utility</li>
  <li>To document your API properly, you must precede every exported class, interface, constructor, method, and field declaration with a doc comment</li>
  <li>If a class is serializable, you should also document its serialized form</li>
  <li>The doc comment for a method should describe succinctly the contract between the method and its client</li>
  <li>With the exception of methods in classes designed for inheritance, the contract should say <strong>what</strong> the method does rather than <strong>how</strong> it does its job.</li>
  <li>Methods should document pre- and postconditions, side effects, thread safety, exceptions</li>
  <li>The first “sentence” of each doc comment should be the summary description</li>
  <li>When documenting a generic type or method, be sure to document all type parameters</li>
  <li>When documenting an enum type, be sure to document the constants</li>
  <li>When documenting an annotation type, be sure to document any members</li>
</ul>

<h3 id="item-45-minimize-the-scope-of-local-variables">Item 45: Minimize the scope of local variables</h3>

<ul>
  <li>The most powerful technique for minimizing the scope of a local variable is to declare it where it is first used</li>
  <li>Nearly every local variable declaration should contain an initializer (<code>try-catch</code> block is an exception)</li>
  <li><code>for</code> loop allows to declare loop variable, prefer it over <code>while</code></li>
  <li>Keep methods small and focused</li>
</ul>

<h3 id="item-46-prefer-for-each-loops-to-traditional-for-loops">Item 46: Prefer for-each loops to traditional for loops</h3>

<ul>
  <li><code>foreach</code> saves from subtle bugs, copy-paste errors, improves readability and maintainability</li>
  <li><code>foreach</code> introduces no performance penalty</li>
  <li>Implement <code>Iterable</code> interface to use custom class in <code>foreach</code> loop</li>
  <li><code>foreach</code> is not used in
    <ul>
      <li>filtering (no access to iterator to call <code>remove</code>)</li>
      <li>transforming (no access to index element to apply change)</li>
      <li>parallel iteration (needed few iterators and control locks)</li>
    </ul>
  </li>
</ul>

<h3 id="item-47-know-and-use-the-libraries">Item 47: Know and use the libraries</h3>

<ul>
  <li>By using a standard library, you take advantage of the knowledge of the experts who wrote it and the experience of those who used it before you</li>
  <li>If a flaw were to be discovered, it would be fixed in the next release</li>
  <li>With using libraries you don’t have to waste your time writing ad hoc solutions to problems that are only marginally related to your work</li>
  <li>Performance of standard libraries tends to improve over time, with no effort on your part</li>
  <li>Libraries tend to gain new functionality over time</li>
</ul>

<h3 id="item-48-avoid-float-and-double-if-exact-answers-are-required">Item 48: Avoid float and double if exact answers are required</h3>

<ul>
  <li>The <code>float</code> and <code>double</code> types are not suited for monetary calculations because it is impossible to represent 0.1 (or any other negative power of ten) as a <code>float</code> or <code>double</code> exactly</li>
  <li>Use <code>BigDecimal</code>, <code>int</code>, or <code>long</code> for monetary calculations</li>
  <li><code>BigDecimal</code> has full control over rounding</li>
  <li>If performance is crucial, you don’t mind keeping track of the decimal point yourself, and the quantities aren’t too big, use <code>int</code> or <code>long</code></li>
</ul>

<h3 id="item-49-prefer-primitive-types-to-boxed-primitives">Item 49: Prefer primitive types to boxed primitives</h3>

<ul>
  <li>Primitives have only their values, whereas boxed primitives have identities distinct from their values.</li>
  <li>Boxed primitive may have <code>null</code> value</li>
  <li>Primitives more time and space-efficient than boxed primitives</li>
  <li>Applying the <code>==</code> operator to boxed primitives is almost always wrong</li>
  <li>When you mix primitives and boxed primitives in a single operation, the boxed primitive is auto-unboxed,</li>
  <li>Use boxed primitives as type parameters in parameterized types</li>
  <li>Use boxed primitives when making reflective method invocations</li>
</ul>

<h3 id="item-50-avoid-strings-where-other-types-are-more-appropriate">Item 50: Avoid strings where other types are more appropriate</h3>

<ul>
  <li>Strings are poor substitutes for other value types (<code>5</code> is better than <code>"5"</code>)</li>
  <li>Strings are poor substitutes for enum types</li>
  <li>Strings are poor substitutes for aggregate types; to access individual fields you must parse string</li>
</ul>

<h3 id="item-51-beware-the-performance-of-string-concatenation">Item 51: Beware the performance of string concatenation</h3>

<ul>
  <li>Using the string concatenation operator repeatedly to concatenate n strings requires O(n^2) time</li>
  <li>To achieve acceptable performance, use a <code>StringBuilder</code> instead</li>
</ul>

<h3 id="item-52-refer-to-objects-by-their-interfaces">Item 52: Refer to objects by their interfaces</h3>

<ul>
  <li>If appropriate interface types exist, then parameters, return values, variables, and fields should all be declared using interface types</li>
  <li>If you depend on any special properties of an implementation, document these requirements where you declare the variable</li>
</ul>

<h3 id="item-53-prefer-interfaces-to-reflection">Item 53: Prefer interfaces to reflection</h3>

<ul>
  <li>Reflection provides programmatic access to the class’s member names, field types, method signatures, etc.</li>
  <li>Using reflection have disadvantages
    <ul>
      <li>No compile-time type checking</li>
      <li>Code verbosity</li>
      <li>Performance suffers</li>
    </ul>
  </li>
  <li>As a rule, objects should not be accessed reflectively in normal applications at runtime</li>
  <li>Create instances reflectively and access them normally via their interface or superclass</li>
  <li>Using reflection cause compiler warnings</li>
</ul>

<h3 id="item-54-use-native-methods-judiciously">Item 54: Use native methods judiciously</h3>

<ul>
  <li>The Java Native Interface (JNI) allows Java applications to call native methods, which are special methods written in native programming languages such as C or C++</li>
  <li>JNI has three main uses
    <ul>
      <li>Access to platform-specific facilities such as registries and file locks</li>
      <li>Access to libraries of legacy code, which could in turn provide access to legacy data</li>
      <li>Used to write performance-critical parts of applications</li>
    </ul>
  </li>
  <li>Do not use native methods for improved performance</li>
  <li>Applications using native methods have disadvantages
    <ul>
      <li>programs are not immune to memory corruption errors</li>
      <li>less portable</li>
      <li>difficult to debug</li>
    </ul>
  </li>
</ul>

<h3 id="item-55-optimize-judiciously">Item 55: Optimize judiciously</h3>

<ul>
  <li>Premature optimization is the root of all evil</li>
  <li>Strive to write good programs rather than fast ones</li>
  <li>Strive to avoid design decisions that limit performance</li>
  <li>Consider the performance consequences of your API design decisions</li>
  <li>Measure performance before and after each attempted optimization</li>
</ul>

<h3 id="item-56-adhere-to-generally-accepted-naming-conventions">Item 56: Adhere to generally accepted naming conventions</h3>

<ul>
  <li>Typographical
    <ul>
      <li>Package: <code>com.google.inject</code>, <code>org.joda.time.format</code></li>
      <li>Class/Interface: <code>Timer</code>, <code>FutureTask</code>, <code>LinkedHashMap</code>, <code>HttpServlet</code></li>
      <li>Method/Field: <code>remove</code>, <code>ensureCapacity</code>, <code>getSrc</code></li>
      <li>Constants: <code>MIN_VALUE</code>, <code>NEGATIVE_INFINITY</code></li>
      <li>Local variable: <code>i</code>, <code>href</code>, <code>houseNumber</code></li>
      <li>Type parameter: <code>T</code>, <code>E</code>, <code>K</code>, <code>V</code>, <code>T1</code>, <code>T2</code></li>
    </ul>
  </li>
  <li>Grammatical
    <ul>
      <li>Class - <em>noun</em>: <code>Timer</code>, <code>Task</code></li>
      <li>Interface - <em>noun</em>, <em>adjective</em> ends with <em>able</em>: <code>Comparator</code>, <code>Comparable</code></li>
      <li>Annotation - <em>noun</em>, <em>verb</em>, <em>preposition</em>, <em>adjective</em>: <code>@Test</code>, <code>@Autowired</code>, <code>@ImplementedBy</code>, <code>@ThreadSafe</code></li>
      <li>Method - <em>verb</em>, rarely <em>noun</em>: <code>drawImage</code>, <code>getDimension</code>, <code>isInterrupted</code>, <code>size</code></li>
      <li>Field - <em>noun</em>: <code>height</code>, <code>capacity</code></li>
    </ul>
  </li>
  <li>Conventions should not be followed blinfly if long-held conventional usage dictates otherwise</li>
</ul>

<h3 id="item-57-use-exceptions-only-for-exceptional-conditions">Item 57: Use exceptions only for exceptional conditions</h3>

<ul>
  <li>Exceptions slower than mormal checks</li>
  <li>Placing code inside a try-catch block inhibits certain optimizations that modern JVM implementations might otherwise perform</li>
  <li>A well-designed API must not force its clients to use exceptions for ordinary control flow</li>
</ul>

<h3 id="item-58-use-checked-exceptions-for-recoverable-conditions-and-runtime-exceptions-for-programming-errors">Item 58: Use checked exceptions for recoverable conditions and runtime exceptions for programming errors</h3>

<ul>
  <li>Java provides three kinds of throwables: checked exceptions, runtime exceptions, and errors</li>
  <li>Checked exceptions <em>force</em> the caller to handle them </li>
  <li>Use checked exceptions for conditions from which the caller can reasonably be expected to recover</li>
  <li>Unchecked exceptions indicate programming error and not needed to be handled <em>almost</em> always</li>
  <li>Errors indicated JVM problems and not needed to be handled at all</li>
</ul>

<h3 id="item-59-avoid-unnecessary-use-of-checked-exceptions">Item 59: Avoid unnecessary use of checked exceptions</h3>

<ul>
  <li>Checked exceptions <em>force</em> the caller to handle them in <code>try-catch</code> block, or propagate outward</li>
  <li>If catching exception provide no benefit (<em>recovery</em>, <em>logging</em>) use unchecked exception</li>
  <li>One technique for turning a checked exception into an unchecked exception is to break the method that throws the exception into two methods, additional method returns a boolean that indicates whether the exception would be thrown</li>
</ul>

<h3 id="item-60-favor-the-use-of-standard-exceptions">Item 60: Favor the use of standard exceptions</h3>

<ul>
  <li><code>IllegalArgumentException</code> caller passes in an argument whose value is inappropriate (e.g. negative value for square root)</li>
  <li><code>IllegalStateException</code> invocation is illegal because of the state of the receiving object (e.g. partially initialized object)</li>
  <li><code>NullPointerException</code> and <code>IndexOutOfBoundsException</code> are more specific versions of <code>IllegalArgumentException</code></li>
  <li><code>ConcurrentModificationException</code> object that was designed for use by a single thread or with external synchronization detects that it is being (or has been) concurrently modified.</li>
  <li><code>UnsupportedOperationException</code> used by implementations that fail to implement one or more optional operations defined by an interface</li>
</ul>

<h3 id="item-61-throw-exceptions-appropriate-to-the-abstraction">Item 61: Throw exceptions appropriate to the abstraction</h3>

<ul>
  <li><strong>Exception translation</strong>. Higher layers should catch lower-level exceptions and, in their place, throw exceptions that can be explained in terms of the higher-level abstraction</li>
</ul>

<p><code>java
try {
  // Use lower-level abstraction to do our bidding
} catch(LowerLevelException e) {
  throw new HigherLevelException();
}
</code></p>

<ul>
  <li><strong>Exception chaining</strong>. Higher-level exception could contain reference to lower-level exception (e.g for debugging)</li>
  <li>While exception translation is superior to mindless propagation of exceptions from lower layers, it should not be overused</li>
</ul>

<h3 id="item-62-document-all-exceptions-thrown-by-each-method">Item 62: Document all exceptions thrown by each method</h3>

<ul>
  <li>Always document checked exceptions with javadoc <code>@throws</code> tag</li>
  <li>Do not document multiple excetions by their common superclass (<code>@throws Exception</code> is bad)</li>
  <li>Document <em>expected</em> unchecked exceptions with javadoc <code>@throws</code> tag</li>
  <li>Do not include unchecked exceptions in method <code>throws</code> declaration</li>
  <li>If an exception is thrown by many methods in a class for the same reason, it is acceptable to document the exception in the class’s documentation comment</li>
</ul>

<h3 id="item-63-include-failure-capture-information-in-detail-messages">Item 63: Include failure-capture information in detail messages</h3>

<ul>
  <li>To capture the failure, the detail message of an exception should contain the values of all parameters and fields that “contributed to the exception”</li>
  <li>To avoid verbosity, include only <em>useful</em> information to exception message</li>
  <li>Exception detail message for programmers, not for users</li>
</ul>

<h3 id="item-64-strive-for-failure-atomicity">Item 64: Strive for failure atomicity</h3>

<ul>
  <li><strong>Failure atomicity</strong> (failed method invocation should leave the object in the state that it was in prior to the invocation)</li>
  <li>If an object is immutable, failure atomicity is free</li>
  <li>If ab object is mutable
    <ul>
      <li>Check parameters for validity before performing the operation</li>
      <li>Perform partial computations and then check for validity</li>
      <li>Write recovery code to return object to its original state after exception</li>
      <li>Make temporary code, apply changes and then replace original object if no exceptions are thrown</li>
    </ul>
  </li>
  <li>Failure atomicity is not always desirable (implementation complexity, performance)</li>
  <li>If method is not failure atomic, reflect that in documentation</li>
</ul>

<h3 id="item-65-dont-ignore-exceptions">Item 65: Don’t ignore exceptions</h3>

<ul>
  <li>Don’t ignore exceptions!</li>
  <li>An empty catch block defeats the purpose of exceptions</li>
  <li>At the very least, the catch block should contain a comment explaining why it is appropriate to ignore the exception</li>
</ul>

<h3 id="item-66-synchronize-access-to-shared-mutable-data">Item 66: Synchronize access to shared mutable data</h3>

<ul>
  <li>Synchronization prevent a thread from observing an object in an inconsistent state</li>
  <li>Synchronization ensures that each thread entering a synchronized method or block sees the effects of all previous modifications that were guarded by the same lock</li>
  <li>Reading or writing a variable is atomic unless the variable is of type <code>long</code> or <code>double</code></li>
  <li>Do not use <code>Thread.stop</code></li>
  <li>A recommended way to stop one thread from another is to have the first thread poll a <code>boolean</code> field that is initially <code>false</code> but can be set to <code>true</code> by the second thread to indicate that the first thread is to stop itself</li>
  <li><strong>Liveness failure</strong> - the program fails to make progress</li>
  <li>Synchronization has no effect unless both read and write operations are synchronized</li>
  <li>Increment operator (<code>++</code>) is not atomic</li>
  <li><strong>Safety failure</strong> - the program computes the wrong results</li>
  <li>Strive to assign mutable data to a single thread</li>
</ul>

<h3 id="item-67-avoid-excessive-synchronization">Item 67: Avoid excessive synchronization</h3>

<ul>
  <li>To avoid liveness and safety failures, never give control to the client within a synchronized method or block</li>
  <li><em>Alien</em> methods may cause data corruption, deadlocks</li>
  <li>Java locks are reentrant</li>
  <li><code>CopyOnWriteArrayList</code> is a variant of <code>ArrayList</code> in which all write operations are implemented by making a fresh copy of the entire underlying array</li>
  <li>Do as little work as possible inside synchronized regions</li>
  <li>When in doubt, do not synchronize your class, but document that it is not thread-safe</li>
</ul>

<h3 id="item-68-prefer-executors-and-tasks-to-threads">Item 68: Prefer executors and tasks to threads</h3>

<ul>
  <li>Executor framework separates unit of work (task) and mechanism (thread creation)</li>
  <li><code>Thread</code> is no longer a key abstraction, use <code>Runnable</code> or <code>Callable</code></li>
  <li><code>Executors.newCachedThreadPool</code> good choice for lightly-loaded server, if no threads available for submitted task, new one will be created</li>
  <li><code>Executors.newFixedThreadPool(n)</code> good choice for heavily-loaded server, Only <code>n</code> threads will be created</li>
</ul>

<h3 id="item-69-prefer-concurrency-utilities-to-wait-and-notify">Item 69: Prefer concurrency utilities to wait and notify</h3>

<ul>
  <li>Prefer higher-level concurrency utilities (Executor Framework, concurrent collections and synchronizers) to <code>wait</code> and <code>notify</code></li>
  <li><code>ConcurrentHashMap</code> is optimized for retrieval operations</li>
  <li>Use <code>ConcurrentHashMap</code> in preference to <code>Collections.synchronizedMap</code> or <code>Hashtable</code></li>
  <li><code>BlockingQueue</code> used for producer-consumer queues</li>
  <li><code>CountdownLatch</code> is a single-use barrier that allow one or more threads to wait for one or more other threads to do something</li>
  <li>For interval timing, always use <code>System.nanoTime</code> in preference to <code>System.currentTimeMillis</code>. <code>System.nanoTime</code> is both more accurate and more precise, and it is not affected by adjustments to the system’s real-time clock.</li>
  <li><code>CyclicBarrier</code> could be used if you need multiple <code>CountDownLatch</code> objects</li>
  <li>Always use the <em>wait loop</em> idiom to invoke the <code>wait</code> method; never invoke it outside of a loop</li>
</ul>

<h3 id="item-70-document-thread-safety">Item 70: Document thread safety</h3>

<ul>
  <li>The presence of the synchronized modifier in a method declaration is an implementation detail, not a part of its exported API</li>
  <li>To enable safe concurrent use, a class must clearly document what level of thread safety it supports
    <ul>
      <li><strong>immutable</strong> - Instances of this class appear constant. No external synchronization is necessary</li>
      <li><strong>unconditionally thread-safe</strong> - Instances of this class are mutable, but the class has sufficient internal synchronization that its instances can be used concurrently without the need for any external synchronization</li>
      <li><strong>conditionally thread-safe</strong> - Like unconditionally thread-safe, except that some methods require external synchronization for safe concurrent use. Examples include the collections returned by the Collections.synchronized wrappers, whose iterators require external synchronization</li>
      <li><strong>not thread-safe</strong> - Instances of this class are mutable. To use them concurrently, clients must surround each method invocation (or invocation sequence) with external synchronization of the clients’ choosing</li>
      <li><strong>thread-hostile</strong> - This class is not safe for concurrent use even if all method invocations are surrounded by external synchronization. Thread hostility usually results from modifying static data without synchronization. No one writes a thread-hostile class on purpose; such classes result from the failure to consider concurrency</li>
    </ul>
  </li>
  <li>To prevent DOS attack, you can use a private lock object instead of using synchronized methods</li>
</ul>

<h3 id="item-71-use-lazy-initialization-judiciously">Item 71: Use lazy initialization judiciously</h3>

<ul>
  <li>Best advice for lazy initialization is “don’t do it unless you need to”</li>
  <li>If you use lazy initialization to break an initialization circularity, use a synchronized accessor</li>
  <li>If you need to use lazy initialization for performance on a static field, use the <em>lazy initialization holder class</em> idiom</li>
  <li>If you need to use lazy initialization for performance on an instance field, use the <em>double-check</em> idiom</li>
</ul>

<h3 id="item-72-dont-depend-on-the-thread-scheduler">Item 72: Don’t depend on the thread scheduler</h3>

<ul>
  <li>Any program that relies on the thread scheduler for correctness or performance is likely to be nonportable.</li>
  <li>The best way to write a robust, responsive, portable program is to ensure that the average number of <em>runnable</em> threads is not significantly greater than the number of processors</li>
  <li>Do not rely on <code>Thread.yield</code> because it has no testable semantics</li>
  <li>Use <code>Thread.sleep(1)</code> instead of <code>Thread.yield()</code> for concurrency testing</li>
  <li>Thread priorities are among the least portable features of the Java platform</li>
</ul>

<h3 id="item-73-avoid-thread-groups">Item 73: Avoid thread groups</h3>

<ul>
  <li>Thread groups do not provide any security functionality</li>
  <li>Thread API is weak</li>
  <li>Prior to release 1.5, there was one small piece of functionality that was available only with the ThreadGroup API the <code>ThreadGroup.uncaughtException</code> method was the only way to gain control when a thread threw an uncaught exception. As of release 1.5, however, the same functionality is available with <code>Thread.setUncaughtExceptionHandler</code> method.</li>
</ul>

<h3 id="item-74-implement-serializable-judiciously">Item 74: Implement Serializable judiciously</h3>

<ul>
  <li>Implementing <code>Serializable</code> decreases the flexibility to change a class’s implementation once it has been released
    <ul>
      <li><code>private</code> and <code>package-private</code> fields become part of its exported API</li>
      <li>incompatible changes after deserialization lead to failure</li>
    </ul>
  </li>
  <li>Define <code>serialVersionUID</code> to avoid <code>InvalidClassException</code></li>
  <li>Because there is no explicit constructor associated with deserialization, it is easy to forget that you must ensure that it guarantees all of the invariants established by the constructors</li>
  <li>Releasing new version of serialized class greatly improves number of test-cases need to be verified</li>
  <li>Classes designed for inheritance should rarely implement <code>Serializable</code></li>
  <li>You should consider providing a parameterless constructor on nonserializable classes designed for inheritance</li>
  <li>Use <em>thread-safe state machine</em> pattern (atomic-reference to enum) to implement a serializable superclass</li>
  <li>Inner classes should not implement <code>Serializable</code></li>
</ul>

<h3 id="item-75-consider-using-a-custom-serialized-form">Item 75: Consider using a custom serialized form</h3>

<ul>
  <li>Do not accept the default serialized form without first considering whether it is appropriate</li>
  <li>The default serialized form is likely to be appropriate if an object’s physical representation is identical to its logical content</li>
  <li>Even if you decide that the default serialized form is appropriate, you often must provide a readObject method to ensure invariants and security</li>
  <li>Before deciding to make a field nontransient, convince yourself that its value is part of the logical state of the object</li>
  <li>Declare an explicit serial version UID in every serializable class you write</li>
</ul>

<h3 id="item-76-write-readobject-methods-defensively">Item 76: Write readObject methods defensively</h3>

<ul>
  <li>For classes with object reference fields that must remain private, defensively copy each object in such a field. Mutable components of immutable classes fall into this category.</li>
  <li>Check any invariants and throw an <code>InvalidObjectException</code> if a check fails. The checks should follow any defensive copying.</li>
  <li>If an entire object graph must be validated after it is deserialized, use the <code>ObjectInputValidation</code> interface</li>
  <li>Do not invoke any overridable methods in the class, directly or indirectly.</li>
</ul>

<h3 id="item-77-for-instance-control-prefer-enum-types-to-readresolve">Item 77: For instance control, prefer enum types to readResolve</h3>

<ul>
  <li>To satisfy singleton property for serializable object, implement <code>readResolve</code></li>
  <li>If you depend on <code>readResolve</code> for instance control, all instance fields with object reference types must be declared <code>transient</code></li>
  <li><code>readResolve</code> is not obsolete. It is needed for writing a serializable instance-controlled class whose instances are not known at compile time</li>
  <li>Use enum types to enforce instance control invariants wherever possible</li>
</ul>

<h3 id="item-78-consider-serialization-proxies-instead-of-serialized-instances">Item 78: Consider serialization proxies instead of serialized instances</h3>

<ul>
  <li>Serialization proxy is a private static inner class implements Serializable and reflects serializable data for original object</li>
  <li>Add <code>writeReplace</code> method to proxy class. Serialization system emits a proxy instance instead of an instance of the enclosing class.</li>
  <li>Add <code>readObject</code> method to proxy class. Attacker wouldn’t be able to violate class invariants.</li>
  <li>Add <code>readResolve</code> method to proxy class that returns logically equialent instance of the enclosing class.</li>
  <li>The serialization proxy pattern has some limitations:
    <ul>
      <li>It is not compatible with classes that are extendable by their clients</li>
      <li>It is not compatible with some classes whose object graphs contain circularities</li>
      <li>Serialization is slower than standard approach</li>
    </ul>
  </li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[randomorg-0.1]]></title>
    <link href="http://mishadoff.github.io/blog/randomorg-0-dot-1/"/>
    <updated>2013-07-06T15:33:00+03:00</updated>
    <id>http://mishadoff.github.io/blog/randomorg-0-dot-1</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/mishadoff/randomorg">randomorg-0.1</a> released!</p>

<!-- more -->

<p>If you use random numbers in your software you might be interested in
better numbers distribution than <code>Random.nextInt()</code>.</p>

<p>Someone solves this problem with hardware generators, few entropy sources and
even <a href="http://www.amazon.com/Million-Random-Digits-Normal-Deviates/dp/0833030477/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1373114958&amp;sr=1-1&amp;keywords=A+Million+Random+Digits+with+100%2C000+Normal+Deviates">books</a>.</p>

<p>By the way, there is great service <a href="http://random.org">random.org</a>
which allows to generate random numbers via atmospheric noise.</p>

<p><strong>randomorg</strong> is a small java library for random.org API.</p>

<p>Check project page for usage and documentation!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Java Magic. Part 4: sun.misc.Unsafe]]></title>
    <link href="http://mishadoff.github.io/blog/java-magic-part-4-sun-dot-misc-dot-unsafe/"/>
    <updated>2013-02-26T02:37:00+02:00</updated>
    <id>http://mishadoff.github.io/blog/java-magic-part-4-sun-dot-misc-dot-unsafe</id>
    <content type="html"><![CDATA[<p>Java is a safe programming language and prevents programmer
from doing a lot of stupid mistakes, most of which based on memory management.
But, there is a way to do such <em>mistakes</em> intentionally, using <code>Unsafe</code> class.</p>

<p>This article is a quick overview of <code>sun.misc.Unsafe</code> <em>public</em> API and few
interesting cases of its usage.</p>

<!-- more -->

<h3 id="unsafe-instantiation">Unsafe instantiation</h3>

<p>Before usage, we need to create instance of <code>Unsafe</code> object.
There is no simple way to do it like <code>Unsafe unsafe = new Unsafe()</code>,
because <code>Unsafe</code> class has private constructor. It also has static
<code>getUnsafe()</code> method, but if you naively try to call <code>Unsafe.getUnsafe()</code> you, probably,
get <code>SecurityException</code>. Using this method available only from trusted code.</p>

<p><code>java
public static Unsafe getUnsafe() {
    Class cc = sun.reflect.Reflection.getCallerClass(2);
    if (cc.getClassLoader() != null)
        throw new SecurityException("Unsafe");
    return theUnsafe;
}
</code></p>

<p>This is how java validates if code is trusted.
It is just checking that our code was loaded with
primary classloader.</p>

<p>We can make our code “trusted”. Use option <code>bootclasspath</code> when running
your program and specify
path to system classes plus your one that will use <code>Unsafe</code>.</p>

<p><code>java
java -Xbootclasspath:/usr/jdk1.7.0/jre/lib/rt.jar:. com.mishadoff.magic.UnsafeClient
</code></p>

<p>But it’s too hard.</p>

<p><code>Unsafe</code> class contains its instance called <code>theUnsafe</code>, which marked as <code>private</code>.
We can steal that variable via java reflection.</p>

<p><code>java
Field f = Unsafe.class.getDeclaredField("theUnsafe");
f.setAccessible(true);
Unsafe unsafe = (Unsafe) f.get(null);
</code></p>

<p><em>Note:</em> Ignore your IDE. For example, eclipse show error “Access restriction…”
but if you run code, all works just fine. If the error is annoying, ignore errors on
<code>Unsafe</code> usage in:</p>

<pre><code>Preferences -&gt; Java -&gt; Compiler -&gt; Errors/Warnings -&gt;
Deprecated and restricted API -&gt; Forbidden reference -&gt; Warning
</code></pre>

<h3 id="unsafe-api">Unsafe API</h3>

<p>Class <a href="http://www.docjar.com/docs/api/sun/misc/Unsafe.html">sun.misc.Unsafe</a>
consists of <code>105</code> methods. There are, actually,
few groups of important methods for manipulating with various entities.
Here is some of them:</p>

<ul>
  <li><strong>Info</strong>. Just returns some low-level memory information.
    <ul>
      <li><code>addressSize</code></li>
      <li><code>pageSize</code></li>
    </ul>
  </li>
  <li><strong>Objects</strong>. Provides methods for object and its fields manipulation.
    <ul>
      <li><code>allocateInstance</code></li>
      <li><code>objectFieldOffset</code></li>
    </ul>
  </li>
  <li><strong>Classes</strong>. Provides methods for classes and static fields manipulation.
    <ul>
      <li><code>staticFieldOffset</code></li>
      <li><code>defineClass</code></li>
      <li><code>defineAnonymousClass</code></li>
      <li><code>ensureClassInitialized</code></li>
    </ul>
  </li>
  <li><strong>Arrays</strong>. Arrays manipulation.
    <ul>
      <li><code>arrayBaseOffset</code></li>
      <li><code>arrayIndexScale</code></li>
    </ul>
  </li>
  <li><strong>Synchronization</strong>. Low level primitives for synchronization.
    <ul>
      <li><code>monitorEnter</code></li>
      <li><code>tryMonitorEnter</code></li>
      <li><code>monitorExit</code></li>
      <li><code>compareAndSwapInt</code></li>
      <li><code>putOrderedInt</code></li>
    </ul>
  </li>
  <li><strong>Memory</strong>. Direct memory access methods.
    <ul>
      <li><code>allocateMemory</code></li>
      <li><code>copyMemory</code></li>
      <li><code>freeMemory</code></li>
      <li><code>getAddress</code></li>
      <li><code>getInt</code></li>
      <li><code>putInt</code></li>
    </ul>
  </li>
</ul>

<h3 id="interesting-use-cases">Interesting use cases</h3>

<h4 id="avoid-initialization">Avoid initialization</h4>

<p><code>allocateInstance</code> method can be <em>useful</em> when you need to skip object initialization phase
or bypass security checks in constructor or you want instance of that class
but don’t have any public constructor. Consider following class:</p>

<p>``` java
class A {
    private long a; // not initialized value</p>

<pre><code>public A() {
    this.a = 1; // initialization
}

public long a() { return this.a; } } ```
</code></pre>

<p>Instantiating it using constructor, reflection and unsafe gives
different results.</p>

<p>``` java
A o1 = new A(); // constructor
o1.a(); // prints 1</p>

<p>A o2 = A.class.newInstance(); // reflection
o2.a(); // prints 1</p>

<p>A o3 = (A) unsafe.allocateInstance(A.class); // unsafe
o3.a(); // prints 0
```</p>

<p>Just think what happens to all your <a href="http://en.wikipedia.org/wiki/Singleton_pattern">Singletons</a>.</p>

<h4 id="memory-corruption">Memory corruption</h4>

<p>This one is usual for every C programmer.
By the way, its common technique for security bypass.</p>

<p>Consider some simple class that check access rules:</p>

<p>``` java
class Guard {
    private int ACCESS_ALLOWED = 1;</p>

<pre><code>public boolean giveAccess() {
    return 42 == ACCESS_ALLOWED;
} } ```
</code></pre>

<p>The client code is <em>very secure</em> and calls
<code>giveAccess()</code> to check access rules. Unfortunately, for clients,
it always returns <code>false</code>. Only privileged users <em>somehow</em> can change
value of <code>ACCESS_ALLOWED</code> constant and get access.</p>

<p>In fact, it’s not true. Here is the code demostrates it:</p>

<p>``` java
Guard guard = new Guard();
guard.giveAccess();   // false, no access</p>

<p>// bypass
Unsafe unsafe = getUnsafe();
Field f = guard.getClass().getDeclaredField(“ACCESS_ALLOWED”);
unsafe.putInt(guard, unsafe.objectFieldOffset(f), 42); // memory corruption</p>

<p>guard.giveAccess(); // true, access granted
```</p>

<p>Now all clients will get unlimited access.</p>

<p>Actually, the same functionality can be achieved by reflection.
But interesting, that we can modify any object, even ones
that we do not have references to.</p>

<p>For example, there is another <code>Guard</code> object in memory
located next to current <code>guard</code> object. We can modify its <code>ACCESS_ALLOWED</code> field with the following code</p>

<p><code>java
unsafe.putInt(guard, 16 + unsafe.objectFieldOffset(f), 42); // memory corruption
</code></p>

<p>Note, we didn’t use any reference to this object.
<code>16</code> is size of <code>Guard</code> object in 32 bit architecture.
We can calculate it manually or use <code>sizeOf</code> method, that defined… right now.</p>

<h4 id="sizeof"><strong>sizeOf</strong></h4>

<p>Using <code>objectFieldOffset</code> method we can implement C-style <code>sizeof</code> function.
This implementation returns <em>shallow</em> size of object:</p>

<p>``` java
public static long sizeOf(Object o) {
    Unsafe u = getUnsafe();
    HashSet<field> fields = new HashSet<field>();
    Class c = o.getClass();
    while (c != Object.class) {
        for (Field f : c.getDeclaredFields()) {
            if ((f.getModifiers() &amp; Modifier.STATIC) == 0) {
                fields.add(f);
            }
        }
        c = c.getSuperclass();
    }</field></field></p>

<pre><code>// get offset
long maxSize = 0;
for (Field f : fields) {
    long offset = u.objectFieldOffset(f);
    if (offset &gt; maxSize) {
        maxSize = offset;
    }
}

return ((maxSize/8) + 1) * 8;   // padding } ```
</code></pre>

<p>Algorithm is the following: go through all <em>non-static</em> fields including all
superclases, get offset for each field, find maximum and add padding.
Probably, I missed something, but idea is clear.</p>

<p>Much simpler <code>sizeOf</code> can be achieved if we just read <code>size</code> value from
the class struct for this object, which located with offset 12 in <code>JVM 1.7 32 bit</code>.</p>

<p><code>java
public static long sizeOf(Object object){
    return getUnsafe().getAddress(
        normalize(getUnsafe().getInt(object, 4L)) + 12L);
}
</code></p>

<p><code>normalize</code> is a method for casting signed int to unsigned long, for
correct address usage.</p>

<p><code>java
private static long normalize(int value) {
    if(value &gt;= 0) return value;
    return (~0L &gt;&gt;&gt; 32) &amp; value;
}
</code></p>

<p>Awesome, this method returns the same result as our previous <code>sizeof</code>
function.</p>

<p>In fact, for good, safe and accurate <code>sizeof</code> function better to use
<a href="http://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html">java.lang.instrument</a> package,
but it requires specifyng <code>agent</code> option in your JVM.</p>

<h4 id="shallow-copy"><strong>Shallow copy</strong></h4>

<p>Having implementation of calculating shallow object size, we can simply
add function that copy objects. Standard solution need modify your code with <code>Cloneable</code>,
or you can implement custom copy function in your object, but it won’t be multipurpose function.</p>

<p>Shallow copy:</p>

<p><code>java
static Object shallowCopy(Object obj) {
    long size = sizeOf(obj);
    long start = toAddress(obj);
    long address = getUnsafe().allocateMemory(size);
    getUnsafe().copyMemory(start, address, size);
    return fromAddress(address);
}
</code></p>

<p><code>toAddress</code> and <code>fromAddress</code> convert object to its address in memory and vice versa.</p>

<p>``` java
static long toAddress(Object obj) {
    Object[] array = new Object[] {obj};
    long baseOffset = getUnsafe().arrayBaseOffset(Object[].class);
    return normalize(getUnsafe().getInt(array, baseOffset));
}</p>

<p>static Object fromAddress(long address) {
    Object[] array = new Object[] {null};
    long baseOffset = getUnsafe().arrayBaseOffset(Object[].class);
    getUnsafe().putLong(array, baseOffset, address);
    return array[0];
}
```</p>

<p>This copy function can be used to copy object of any type, its size will be calculated
dynamically. Note that after copying you need to cast object to specific type.</p>

<h4 id="hide-password">Hide Password</h4>

<p>One more interesting usage of direct memory access in <code>Unsafe</code> is removing
unwanted objects from memory.</p>

<p>Most of the APIs for retrieving user’s password, have signature
as <code>byte[]</code> or <code>char[]</code>. Why arrays?</p>

<p>It is completely for security reason, because we can nullify array elements after we don’t need them.
If we retrieve password as <code>String</code> it can be saved like an object in memory and nullifying that
string just perform dereference operation. This object still in memory by the time GC decide to perform cleanup.</p>

<p>This trick creates fake <code>String</code> object with the same size and replace original one in memory:</p>

<p>``` java
String password = new String(“l00k@myHor$e”);
String fake = new String(password.replaceAll(“.”, “?”));
System.out.println(password); // l00k@myHor$e
System.out.println(fake); // ????????????</p>

<p>getUnsafe().copyMemory(
          fake, 0L, null, toAddress(password), sizeOf(password));</p>

<p>System.out.println(password); // ????????????
System.out.println(fake); // ????????????
```</p>

<p>Feel safe.</p>

<p><strong>UPDATE:</strong> That way is not really safe. For real safety we need to nullify
backed char array via reflection:</p>

<p><code>java
Field stringValue = String.class.getDeclaredField("value");
stringValue.setAccessible(true);
char[] mem = (char[]) stringValue.get(password);
for (int i=0; i &lt; mem.length; i++) {
  mem[i] = '?';
}
</code></p>

<p>Thanks to <em>Peter Verhas</em> for pointing out that.</p>

<h4 id="multiple-inheritance"><strong>Multiple Inheritance</strong></h4>

<p>There is no multiple inheritance in java.</p>

<p>Correct, except we can cast every type to every another one, if we want.</p>

<p><code>java
long intClassAddress = normalize(getUnsafe().getInt(new Integer(0), 4L));
long strClassAddress = normalize(getUnsafe().getInt("", 4L));
getUnsafe().putAddress(intClassAddress + 36, strClassAddress);
</code></p>

<p>This snippet adds <code>String</code> class to <code>Integer</code> superclasses, so we can cast
without runtime exception.</p>

<p><code>java
(String) (Object) (new Integer(666))
</code></p>

<p>One problem that we must do it with pre-casting to object. To cheat compiler.</p>

<h4 id="dynamic-classes">Dynamic classes</h4>

<p>We can create classes in runtime, for example from
compiled <code>.class</code> file. To perform that read class contents
to byte array and pass it properly to <code>defineClass</code> method.</p>

<p><code>java
byte[] classContents = getClassContent();
Class c = getUnsafe().defineClass(
              null, classContents, 0, classContents.length);
    c.getMethod("a").invoke(c.newInstance(), null); // 1
</code></p>

<p>And reading from file defined as:</p>

<p><code>java
private static byte[] getClassContent() throws Exception {
    File f = new File("/home/mishadoff/tmp/A.class");
    FileInputStream input = new FileInputStream(f);
    byte[] content = new byte[(int)f.length()];
    input.read(content);
    input.close();
    return content;
}
</code></p>

<p>This can be useful, when you must create classes dynamically, some proxies
or aspects for existing code.</p>

<h4 id="throw-an-exception">Throw an Exception</h4>

<p>Don’t like checked exceptions? Not a problem.</p>

<p><code>java
getUnsafe().throwException(new IOException());
</code></p>

<p>This method throws checked exception, but your code not forced to catch or rethrow it.
Just like runtime exception.</p>

<h4 id="fast-serialization">Fast Serialization</h4>

<p>This one is more practical.</p>

<p>Everyone knows that standard java <code>Serializable</code> capability
to perform serialization is very slow. It also require class
to have public non-argument constructor.</p>

<p><code>Externalizable</code> is better, but it needs to define schema for
class to be serialized.</p>

<p>Popular high-performance libraries, like <a href="http://code.google.com/p/kryo/">kryo</a>
have dependencies, which can be unacceptable with low-memory requirements.</p>

<p>But full serialization cycle can be easily achieved with unsafe class.</p>

<p>Serialization:</p>

<ul>
  <li>Build schema for object using reflection. It can be done once for class.</li>
  <li>Use <code>Unsafe</code> methods <code>getLong</code>, <code>getInt</code>, <code>getObject</code>, etc. to retrieve actual field values.</li>
  <li>Add <code>class</code> identifier to have capability restore this object.</li>
  <li>Write them to the file or any output.</li>
</ul>

<p>You can also add compression to save space.</p>

<p>Deserialization:</p>

<ul>
  <li>Create instance of serialized class. <code>allocateInstance</code> helps, because does not require any constructor.</li>
  <li>Build schema. The same as 1 step in serialization.</li>
  <li>Read all fields from file or any input.</li>
  <li>Use <code>Unsafe</code> methods <code>putLong</code>, <code>putInt</code>, <code>putObject</code>, etc. to fill the object.</li>
</ul>

<p>Actually, there are much more details in correct inplementation, but intuition is clear.</p>

<p>This serialization will be really fast.</p>

<p>By the way, there are some attempts in <code>kryo</code> to use <code>Unsafe</code> <a href="http://code.google.com/p/kryo/issues/detail?id=75">http://code.google.com/p/kryo/issues/detail?id=75</a></p>

<h4 id="big-arrays"><strong>Big Arrays</strong></h4>

<p>As you know <code>Integer.MAX_VALUE</code> constant is a max size of java array.
Using direct memory allocation we can create arrays with size limited by only heap size.</p>

<p>Here is <code>SuperArray</code> implementation:</p>

<p>``` java
class SuperArray {
    private final static int BYTE = 1;</p>

<pre><code>private long size;
private long address;

public SuperArray(long size) {
    this.size = size;
    address = getUnsafe().allocateMemory(size * BYTE);
}

public void set(long i, byte value) {
    getUnsafe().putByte(address + i * BYTE, value);
}

public int get(long idx) {
    return getUnsafe().getByte(address + idx * BYTE);
}

public long size() {
    return size;
} } ```
</code></pre>

<p>And sample usage:</p>

<p><code>java
long SUPER_SIZE = (long)Integer.MAX_VALUE * 2;
SuperArray array = new SuperArray(SUPER_SIZE);
System.out.println("Array size:" + array.size()); // 4294967294
for (int i = 0; i &lt; 100; i++) {
    array.set((long)Integer.MAX_VALUE + i, (byte)3);
    sum += array.get((long)Integer.MAX_VALUE + i);
}
System.out.println("Sum of 100 elements:" + sum);  // 300
</code></p>

<p>In fact, this technique uses <code>off-heap memory</code> and partially
available in <code>java.nio</code> package.</p>

<p>Memory allocated this way not located in the heap and not under GC management, so take care of it
using <code>Unsafe.freeMemory()</code>. It also does not perform any boundary checks, so any
illegal access may cause JVM crash.</p>

<p>It can be useful for math computations, where code can operate with large arrays of data.
Also, it can be interesting for realtime programmers, where GC delays on large arrays can
break the limits.</p>

<h4 id="concurrency">Concurrency</h4>

<p>And few words about concurrency with <code>Unsafe</code>.
<code>compareAndSwap</code> methods are atomic and can be used to implement
high-performance lock-free data structures.</p>

<p>For example, consider the problem to increment value in the shared object
using lot of threads.</p>

<p>First we define simple interface <code>Counter</code>:</p>

<p><code>java
interface Counter {
    void increment();
    long getCounter();
}
</code></p>

<p>Then we define worker thread <code>CounterClient</code>, that uses <code>Counter</code>:</p>

<p>``` java
class CounterClient implements Runnable {
    private Counter c;
    private int num;</p>

<pre><code>public CounterClient(Counter c, int num) {
    this.c = c;
    this.num = num;
}

@Override
public void run() {
    for (int i = 0; i &lt; num; i++) {
        c.increment();
    }
} } ```
</code></pre>

<p>And this is testing code:</p>

<p><code>java
int NUM_OF_THREADS = 1000;
int NUM_OF_INCREMENTS = 100000;
ExecutorService service = Executors.newFixedThreadPool(NUM_OF_THREADS);
Counter counter = ... // creating instance of specific counter
long before = System.currentTimeMillis();
for (int i = 0; i &lt; NUM_OF_THREADS; i++) {
    service.submit(new CounterClient(counter, NUM_OF_INCREMENTS));
}
service.shutdown();
service.awaitTermination(1, TimeUnit.MINUTES);
long after = System.currentTimeMillis();
System.out.println("Counter result: " + c.getCounter());
System.out.println("Time passed in ms:" + (after - before));
</code></p>

<p>First implementation is not-synchronized counter:</p>

<p>``` java
class StupidCounter implements Counter {
    private long counter = 0;</p>

<pre><code>@Override
public void increment() {
    counter++;
}

@Override
public long getCounter() {
    return counter;
} } ```
</code></pre>

<p>Output:</p>

<p><code>
Counter result: 99542945
Time passed in ms: 679
</code></p>

<p>Working fast, but no threads management at all, so result is inaccurate.
Second attempt, add easiest java-way synchronization:</p>

<p>``` java
class SyncCounter implements Counter {
    private long counter = 0;</p>

<pre><code>@Override
public synchronized void increment() {
    counter++;
}

@Override
public long getCounter() {
    return counter;
} } ```
</code></pre>

<p>Output:</p>

<p><code>
Counter result: 100000000
Time passed in ms: 10136
</code></p>

<p>Radical synchronization always work. But timings is awful.
Let’s try <code>ReentrantReadWriteLock</code>:</p>

<p>``` java
class LockCounter implements Counter {
    private long counter = 0;
    private WriteLock lock = new ReentrantReadWriteLock().writeLock();</p>

<pre><code>@Override
public void increment() {
    lock.lock();
    counter++;
    lock.unlock();
}

@Override
public long getCounter() {
    return counter;
} } ```
</code></pre>

<p>Output:</p>

<p><code>
Counter result: 100000000
Time passed in ms: 8065
</code></p>

<p>Still correct, and timings are better. What about atomics?</p>

<p>``` java
class AtomicCounter implements Counter {
    AtomicLong counter = new AtomicLong(0);</p>

<pre><code>@Override
public void increment() {
    counter.incrementAndGet();
}

@Override
public long getCounter() {
    return counter.get();
} } ```
</code></pre>

<p>Output:</p>

<p><code>
Counter result: 100000000
Time passed in ms: 6552
</code></p>

<p><code>AtomicCounter</code> is even better. Finally, try <code>Unsafe</code>
primitive <code>compareAndSwapLong</code> to see if it is really privilegy to use it.</p>

<p>``` java
class CASCounter implements Counter {
    private volatile long counter = 0;
    private Unsafe unsafe;
    private long offset;</p>

<pre><code>public CASCounter() throws Exception {
    unsafe = getUnsafe();
    offset = unsafe.objectFieldOffset(CASCounter.class.getDeclaredField("counter"));
}

@Override
public void increment() {
    long before = counter;
    while (!unsafe.compareAndSwapLong(this, offset, before, before + 1)) {
        before = counter;
    }
}

@Override
public long getCounter() {
    return counter;
} ```
</code></pre>

<p>Output:</p>

<p><code>
Counter result: 100000000
Time passed in ms: 6454
</code></p>

<p>Hmm, seems equal to atomics. Maybe atomics use <code>Unsafe</code>? (<em>YES</em>)</p>

<p>In fact this example is easy enough, but it shows some power of <code>Unsafe</code>.</p>

<p>As I said, <code>CAS</code> primitive can be used to implement lock-free data structures.
The intuition behind this is simple:</p>

<ul>
  <li>Have some state</li>
  <li>Create a copy of it</li>
  <li>Modify it</li>
  <li>Perform <code>CAS</code></li>
  <li>Repeat if it fails</li>
</ul>

<p>Actually, in real it is more hard than you can imagine. There are a lot of problems like
<a href="http://en.wikipedia.org/wiki/ABA_problem">ABA Problem</a>, instructions reordering, etc.</p>

<p>If you really interested, you can refer to the awesome presentation about <a href="http://www.azulsystems.com/about_us/presentations/lock-free-hash">lock-free HashMap</a></p>

<p><strong>UPDATE:</strong> Added <code>volatile</code> keyword to <code>counter</code> variable to avoid risk of infinite loop.</p>

<p>Kudos to <em>Nitsan Wakart</em></p>

<h3 id="bonus">Bonus</h3>

<p>Documentation for <code>park</code> method from <code>Unsafe</code> class contains
longest English sentence I’ve ever seen:</p>

<blockquote>
  <p>Block current thread, returning when a balancing
unpark occurs, or a balancing unpark has
already occurred, or the thread is interrupted, or, if not
absolute and time is not zero, the given time nanoseconds have
elapsed, or if absolute, the given deadline in milliseconds
since Epoch has passed, or spuriously (i.e., returning for no
“reason”). Note: This operation is in the Unsafe class only
because unpark is, so it would be strange to place it
elsewhere.</p>
</blockquote>

<h3 id="conclusion">Conclusion</h3>

<p>Although, <code>Unsafe</code> has a bunch of useful applications, never use it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Critical Software Bugs: Part 1]]></title>
    <link href="http://mishadoff.github.io/blog/critical-software-bugs-part-1/"/>
    <updated>2013-01-20T18:48:00+02:00</updated>
    <id>http://mishadoff.github.io/blog/critical-software-bugs-part-1</id>
    <content type="html"><![CDATA[<p>Little journey through the history of most critical software bugs
with some code examples.</p>

<p><em>Do not try to reproduce any of these!</em></p>

<!-- more -->

<h3 id="intro">Intro</h3>

<blockquote>
  <p>Every last bug is the last but one.</p>
</blockquote>

<p><strong>Bugs</strong> are bad. Some of them cause uncomfortable work, more actions
than expected, inconsistency, layout issues, etc.
Some of them “<a href="http://en.wikipedia.org/wiki/Undocumented_feature">not a bug</a>” at all.</p>

<p><strong>Bad bugs</strong> much worse. They cause data corruption, invalid data representation,
unavailability to perform action, losing integrity and so on.</p>

<p>There are <strong>critical bugs</strong> with painful consequences. They can damage the health, nature, people
break buildings, technics. Theoretically, they
<a href="http://www.washingtonpost.com/wp-srv/inatl/longterm/coldwar/shatter021099b.htm">can lead to World War III</a>.
Hope, it’s just theoretically.</p>

<p>If you are software engineer, you definitely will commit the bugs. No panacea.
But if we aware about common mistakes, then less likely we make that mistakes.</p>

<p>This article is review of famous most critical software bugs
including brief history, consequences, root causes, possible solutions, code examples and some advices.</p>

<h3 id="mariner-1httpenwikipediaorgwikimariner1-1962"><a href="http://en.wikipedia.org/wiki/Mariner_1">Mariner 1</a> (1962)</h3>

<p><strong>History:</strong>
In 1962, spacecraft <em>Mariner 1</em> was guided by computer program with error causes
racket do not follow its expected trajectory. To prevent tragic consequences, racket
was destoyed immediately.</p>

<p><strong>Consequences:</strong> Money, $18 million.</p>

<p><strong>Reason:</strong>
There are tons of versions about what type of error it was, but official version
is <em>missing hyphen</em> (‘-‘) in program. Maybe it’s just a myth for publicity,
but, anyway, if the reason of bug is incorrect handwritten formula transcription
from paper to computer, it’s sad.</p>

<p>Probably, the root cause of that is writer and computer operator were different people.
It’s common case for that times. <em>Programming</em> was synonym to the <em>scientific calculations</em> not
an enterprise, as nowadays. That’s why scientist, programmer, and operator could be
different people.</p>

<p>Related story, it’s why zero symbol has a period or diagonal line inside - to prevent
confusing with “big O” for “typer” person. Just compare <code>0</code> and <code>O</code>.</p>

<p><strong>Solution:</strong>
It’s hardly can be a problem today (as it was 50 years ago), but if you write for somebody on the paper, write it accurate.
If you type into computer from someone’s paper sheet, check, re-check and double re-check
what you typing. Ask if you have concerns. Especially, if it is the program for spaceship.</p>

<p>In very <em>far-fetched</em> example missing minus sign can result into invalid computation:</p>

<p>``` java
double getDiscountPercent() {
    return 0.25; // instead of return -0.25;
}</p>

<p>double calculatePrice(double initial) {
    return initial * (1.0 + getDiscountPercent());
}
```</p>

<p>That way instead of paying $75, you pay $125.</p>

<p><strong>Lesson:</strong> Always check your manual rewriting actions.</p>

<h3 id="siberian-pipeline-sabotagehttpenwikipediaorgwikisiberianpipelinesabotage-1982"><a href="http://en.wikipedia.org/wiki/Siberian_pipeline_sabotage">Siberian pipeline sabotage</a> (1982)</h3>

<p><strong>History:</strong> Cold war. Soviet Union steal technology for managing gas pipelines from Canada. This
technology intentionally contained the bug (<a href="http://en.wikipedia.org/wiki/Logic_bomb">Logic Bomb</a>), developed by CIA
for sabotage purposes. Bomb triggered.</p>

<p><strong>Consequences:</strong> The greatest non-nuclear explosion in the world.</p>

<p><strong>Reason:</strong> Every microship from stolen technology would
work fine just for 10 million cycles, after that switches to another mode.</p>

<p>They <em>used someone’s code</em>.</p>

<p><strong>Solution:</strong></p>

<blockquote>
  <p>You shall not steal</p>

  <p>– <a href="http://en.wikipedia.org/wiki/Ten_Commandments">Ten Commandments</a></p>
</blockquote>

<p>Honestly, if someone’s technology used for critical areas, like gas
transportation, it must be reviewed and tested. 100 times.</p>

<p>Story can be translated as:</p>

<p>I found memory card on the city dump.
Card contained one shell script <code>please-execute-me.sh</code>.
I <em>executed</em> it. System crashed. Who’s guilty? Just me.</p>

<p>Use software from trusted sources.</p>

<p>In modern software world, we often use someone’s libraries, frameworks,
APIs to build our own applications. We <em>expect</em> that code is <em>reviewed</em> and <em>tested</em>.
If not, we can help to do it. How we can be sure these libs without logic bombs?</p>

<p>Trust or review the sources. That’s why I love open source software.</p>

<p>Logic bomb detection is not that hard. Just find the code that causes error
and see the reason of that error. Again, code review helps <em>to prevent</em> the
logic bomb instead of <em>fixing it</em>. Build application to production only from
version control system (<em>which is controlled, right?</em>)</p>

<p>Just for educational purposes: simple example of time-triggered logic bomb</p>

<p>``` java
public class LogicBombRunner {
        public static void main(String[] args) {
                Thread thread = new Thread(new LogicBomb());
                thread.start();
        }
}</p>

<p>class LogicBomb implements Runnable {</p>

<pre><code>    private long toStop;
    private final long TIME_TO_TRIGGER = 1000 * 60 * 60 * 24 * 100;

    public LogicBomb() {
            toStop = System.currentTimeMillis() + TIME_TO_TRIGGER;
    }

    @Override
    public void run() {
            while (true) {
                    if (System.currentTimeMillis() &lt; toStop) {
                            System.out.println("System works fine.");
                            try {
                                    Thread.sleep(1000);
                            } catch (InterruptedException e) {
                                    e.printStackTrace();
                            }
                    } else {
                            System.out.println("Logic bomb triggered.");
                            throw new RuntimeException();
                    }
            }
    } }
</code></pre>

<p>```</p>

<p>Yes. It throws <code>RuntimeException</code> after approximately 100 days from <code>LogicBomb</code> object creation.</p>

<p><strong>Lesson:</strong> Do not steal. Trust to very limited circle of people.</p>

<h3 id="therac-25httpenwikipediaorgwikitherac-25-1985---1987"><a href="http://en.wikipedia.org/wiki/Therac-25">Therac-25</a> (1985 - 1987)</h3>

<p><strong>History:</strong> Therac-25 was a medical device for radiation therapy.
It could deliver either beta-particles or X-rays. Unfortunately,
operating system for controling the device was written with error,
that causes sad results.</p>

<p><strong>Consequences:</strong> At least 2 patients died, 4 patients were given overdose,
approximately 100 times intended dose.</p>

<p><strong>Reason:</strong> Investigation concluded the common reason was a
<em>bad software design</em>, <em>development practices</em> and a <em>set of bugs</em>
instead of some particular critical bug.</p>

<p>These bad practices and bugs include:</p>

<ul>
  <li>No code review</li>
  <li>Poor exception handling</li>
  <li>No integration testing until device was assembled in the hospital</li>
  <li>Poor hardware design</li>
  <li><em>Bad code</em> reuse</li>
  <li>Concurrency issues</li>
</ul>

<p><strong>Solution:</strong> Code review its a must. Even if you working
alone in the team, show sources to some your friend (programmer).
Two pair of eyes can spot the mistake two times more.</p>

<p><em>Poor exception handling</em>. If failure occurs, no one knows about that failure.
Never handle exception like that:</p>

<p>``` java
catch (SomeException e) {</p>

<p>}
```</p>

<p>In 99% there are must be a proper handling. If you don’t know how
to handle, rethrow it, possible with wrapping:</p>

<p><code>java
catch (SomeException e) {
   throw new SpecificException(e);
}
</code></p>

<p>Much better to throw responsibility for handling one level up
in method signature:</p>

<p><code>java
void method() throws SomeException
</code></p>

<p>If your real intention to left catch block empty, say this:</p>

<p><code>java
catch (SomeExcpetion e) {
  // swallowing this exception is intended
}
</code></p>

<p><em>Bad code reuse</em>. <a href="http://en.wikipedia.org/wiki/Code_reuse">Code reuse</a> is a good thing.
Except the case when you reuse something with errors.</p>

<p>For example, I have following method for testing if number is even in some of my
previous projects (<em>yes, look at your code that was written few years ago</em>):</p>

<p><code>java
static boolean isEven(int num) {
    return num % 2 != 1;
}
</code></p>

<p>This method returns incorrect result <code>true</code> for all negative odd numbers. Just because
<code>%</code> operator returns <code>-1</code> except <code>1</code> for negative numbers. Better do <em>NOT</em> reuse such method.
Just write new. And replace old method immediately.</p>

<p><code>java
static boolean isEven(int num) {
    return num % 2 == 0;
}
</code></p>

<p><em>Concurrency</em>. Software world hardest issues are concurrency issues.</p>

<blockquote>
  <p>You have a problem and decide to use threads.
Two now problems have you.</p>

  <p>– Some guy from internet
<br /></p>
</blockquote>

<blockquote>
  <p>You have a problem and decide to use locks.
Now you have</p>

  <p>– Some another guy from internet</p>
</blockquote>

<p>If you know that some object will be shared between threads, one solution to
add <code>synchronized</code> (<a href="http://en.wikipedia.org/wiki/Monitor_%28synchronization%29">Monitor object</a>)
to each read/write state method. It will slow
your work with that object but prevent a lot of unexpected errors.</p>

<p>Although, there are much flexible synchronization mechanisms in java that
plain old <code>synchronized</code> as <a href="http://en.wikipedia.org/wiki/Semaphore_%28programming%29">semaphores</a>,
<a href="http://en.wikipedia.org/wiki/Mutual_exclusion">mutexes</a>,
<a href="http://en.wikipedia.org/wiki/Read_write_lock_pattern">read-write locks</a>.</p>

<p>I reccomend to use java package <a href="http://docs.oracle.com/javase/6/docs/api/java/util/concurrent/package-summary.html">java.util.concurrent</a>.
It consists of a lot of concurrency techniques, like <code>Synchronizers</code>, <code>Executors</code>,
<code>Atomics</code>, <code>Concurrent Collections</code>, <code>Futures</code>, <code>Callbacks</code> etc.</p>

<p><strong>As a bonus:</strong> Good books about concurrency in Java:</p>

<ul>
  <li><a href="http://www.goodreads.com/book/show/127932.Java_Concurrency_in_Practice">Java Concurrency in Practice</a></li>
  <li><a href="http://www.goodreads.com/book/show/629608.Concurrent_Programming_in_Java">Concurrent Programming in Java</a></li>
</ul>

<p><strong>Lesson:</strong> Always handle exceptions. Pay more attention to concurrency issues.</p>

<h3 id="patriot-missilehttpenwikipediaorgwikimim-104patriot-1991"><a href="http://en.wikipedia.org/wiki/MIM-104_Patriot">Patriot Missile</a> (1991)</h3>

<p><strong>History:</strong> In 1991, American battery fired Patriot Missile to intercept Iraq missile.
Interception failed because of system bug in time step calculation.
Iraq missile destroyed an American Army barracks.</p>

<p><strong>Consequences:</strong> 28 soldiers died, 100 injured.</p>

<p><strong>Reason:</strong> Floating point rounding error. System’s internal clock was calculating
time by 0.1 seconds step (0.1, 0.2, 0.3, …). As <code>0.1 = 1/10</code> have infinite binary representation
<code>0.0001100110011001100110011001100110011001100110011001100..</code>
and for this calculation 24-bit register was used,
register hold just <code>0.00011001100110011001100</code> introducing truncating error
<code>0.00000000000000000000000110011</code> what is approximately <code>0.0000001</code> in decimal.</p>

<p>Small enough, huh?</p>

<p>Not really, Multiplying this number for 100 hours gives:</p>

<pre><code>0.0000001 * 100 * 60 * 60 * 10 = 0.36 sec
</code></pre>

<p>During that time Iraq missile travels a half kilometer, and was out of tracking radius
for Patriot Missile. Bad things happen.</p>

<p><strong>Solution:</strong> Floats are very error-prone if we don’t handle them correctly.</p>

<p>Predict the output of the following code:</p>

<p><code>java
for (double d = 0.0; d != 1.0; d = d + 0.1) {
    System.out.println("Iteration");
}
</code></p>

<p>Infinite loop. The same problem as described above.</p>

<p>One solution is to use float that have exact binary representation.
<code>0.125</code>, <code>0.25</code>, <code>0.5</code> for example.
But this greatly reduces the space of allowed values and give less flexibility.</p>

<p>Another solution to use big decimal or ratio types.
Java, as example, have out-of-the-box <code>BigDecimal</code> class. Loop above rewritten with
that class works as expected:</p>

<p>``` java
BigDecimal init = new BigDecimal(“0.0”);
BigDecimal bound = new BigDecimal(“1.0”);
BigDecimal step = new BigDecimal(“0.1”)</p>

<p>for (BigDecimal d = init; !d.equals(bound); d = d.add(step)) {
        System.out.println(d);
}
```</p>

<p>One disadvantage it has slower execution than with floats. Consider trade-off
between time and accuracy. If human lives on the stake, it’s not relevant choice.</p>

<p><code>Ratio</code> class can be defined without any problems and used similar way.</p>

<p><strong>Lesson:</strong> If you need very accurate calculations use big decimals or ratios.</p>

<h3 id="mars-climate-orbiterhttpenwikipediaorgwikimarsclimateorbiter-1998"><a href="http://en.wikipedia.org/wiki/Mars_Climate_Orbiter">Mars Climate Orbiter</a> (1998)</h3>

<p><strong>History:</strong> Again about space. In 1998, communication with Mars Climate Orbiter
was lost, because of changed trajectory. Space probe was crashed near Mars.</p>

<p><strong>Consequences:</strong> Money, $327 million</p>

<p><strong>Reason:</strong> Navigation system design was developed by another team.
To represent Force they used <a href="http://en.wikipedia.org/wiki/Pound-force">pound-force</a>
from <a href="http://en.wikipedia.org/wiki/Imperial_units">Imperial units</a>
instead of <a href="http://en.wikipedia.org/wiki/Newton_%28unit%29">Newton</a>
from <a href="http://en.wikipedia.org/wiki/Metric_system">metric system</a>.</p>

<pre><code>1 Newton = 0.22 pound-force
</code></pre>

<p>Without provided conversion between them system failed.</p>

<p>Issue resemble to using dates in different timezones, but much more critical.</p>

<p><strong>Solution:</strong> First of all, at least one science-aware person must perform code review.
At least for code blocks with formulas and calculations. If there are comments about using pound-force,
the problem easy spotted. Second of all, received code must be tested on model
instead of physical machine. This is also, likely, detects the issue.
Developer who wrote that less guilty, but still guilty.</p>

<p>There are different approaches to implement this in java:</p>

<p>very bad approach, we don’t know what units are used:</p>

<p><code>java
new Force(1.533);
</code></p>

<p>better (still bad) approach to indicate with comment:</p>

<p><code>java
// force in Newtons!
new Force(1.533);
</code></p>

<p>better (still bad) approach to indicate different constructors for different units:</p>

<p><code>java
new ForceInNewtons(1.533);
</code></p>

<p>I prefer approach where you specifies a <em>value</em> and <em>unit</em> in the constructor, and
they converted to something common unit (metric) convenient for use in internal representation:</p>

<p>``` java
enum ForceUnit {
  NEWTON,
  POUND_FORCE
}</p>

<p>new Force(1.533, ForceUnit.NEWTON);
```</p>

<p>A bit more code, but it is understandable and easy to use for different unit systems.
Unit conversion method can be defined either at the <code>enum ForceUnit</code> or <code>class Force</code> level.</p>

<p><strong>Lesson:</strong> Always explicitly indicate what units used in your code.</p>

<p><em>To be continued.</em></p>

<h3 id="links">Links</h3>

<ul>
  <li><a href="http://en.wikipedia.org/wiki/List_of_software_bugs">List of Software Bugs</a></li>
  <li><a href="http://www5.in.tum.de/~huckle/bugse.html">Collection of Software Bugs</a></li>
  <li><a href="http://www.wired.com/software/coolapps/news/2005/11/69355?currentPage=all">History’s Worst Software Bugs</a></li>
  <li><a href="http://www.sundoginteractive.com/sunblog/posts/top-ten-most-infamous-software-bugs-of-all-time">Top Ten Most Infamous Software Bugs Of All Time</a></li>
  <li><a href="http://nssdc.gsfc.nasa.gov/nmc/spacecraftDisplay.do?id=MARIN1">NASA Mariner 1</a></li>
  <li><a href="http://www.wired.com/culture/lifestyle/news/2004/03/62806">Soviets Burned By CIA Hackers?</a></li>
  <li><a href="http://courses.cs.vt.edu/cs3604/lib/Therac_25/Therac_1.html">An Investigation of the Therac-25 Accidents</a></li>
  <li><a href="http://seeri.etsu.edu/SECodeCases/ethicsC/PatriotMissile.htm">An Analysis of the Patriot Missile System</a></li>
  <li><a href="http://www.ima.umn.edu/~arnold/disasters/patriot.html">The Patriot Missile Failure</a></li>
  <li><a href="http://www.tysknews.com/Depts/Metrication/mystery_of_orbiter_crash_solved.htm">Mystery of Orbiter Crash Solved</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Eclipse Speedup]]></title>
    <link href="http://mishadoff.github.io/blog/eclipse-speedup/"/>
    <updated>2012-12-23T18:00:00+02:00</updated>
    <id>http://mishadoff.github.io/blog/eclipse-speedup</id>
    <content type="html"><![CDATA[<p>Have you been in situation where most of the time in eclipse you were waiting for
some operation to be finished?</p>

<!-- more -->

<p><img src="http://upload.wikimedia.org/wikipedia/en/3/34/Eclipse-logo.png" alt="" /></p>

<p>If you here, probably, the answer is yes. You are bored with that slow functionality and want
to increase eclipse performance to make your development work more comfortable. It is the right thing to do.</p>

<p><em>Warning:</em> Most frequent advice I heard <em>to add more RAM</em>. Probably, you can buy better workstation with better CPU.
Add SSD to make filesystem operations faster. We assume you can’t afford all that. All you can is setup your
eclipse instance. All preferences based on <code>Eclipse SDK Version: 4.3.0 Build id: I20121031-2000</code> for ubuntu, but
almost everything is identical in other versions for other platforms.</p>

<h3 id="eclipse-tweaks">Eclipse tweaks</h3>

<h4 id="plugins">Plugins</h4>

<p>First time I found the power of plugins I was excited. I installed them more and more until I couldn’t
work comfortable with eclipse. Probably, you have a lot of plugins, just <strong>disable</strong> on startup ones that not used.
It is not deleting, you always can enable it back.</p>

<pre><code>Window -&gt; Preferences -&gt; General -&gt; Startup and Shutdown
</code></pre>

<p><img src="http://i.imgur.com/kgavA.png" alt="" /></p>

<p>By the way, some plugins appeared due to your experimenting and not used anymore. <strong>Delete</strong> redundant plugins if they
not used at all.</p>

<pre><code>Help -&gt; About Eclipse SDK -&gt; Instalation Details -&gt; &lt;Select plugin&gt; -&gt; Uninstall
</code></pre>

<p><img src="http://i.imgur.com/7wRoR.png" alt="" /></p>

<h4 id="eclipseini">eclipse.ini</h4>

<p>Following tweaks based on editing <code>eclipse.ini</code> file located in root folder
of your eclipse instalation.</p>

<ul>
  <li><strong>Use specific JVM to run eclipse.</strong>
This allows do not take into account system properties which alters your JDK.</li>
</ul>

<p><code>
-vm
/path/to/your/java
</code></p>

<ul>
  <li>
    <p><strong>Use latest JDK to run eclipse.</strong>
Much better if you point your eclipse to the <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">latest JDK</a>.
<em>Rumors</em> said it has better performance.</p>
  </li>
  <li>
    <p><strong>Use Sun JDK to run eclipse.</strong>
The reason behind this has the same explanation.</p>
  </li>
  <li>
    <p><strong>Configure VM arguments.</strong>
You can set your own values for virtual machine if you think
they are appropriate
(<a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html#PerformanceTuning">Performance related options</a>)
I use following settings to increase heap size (objects) to <code>768Mb</code> and permgen (classes) to <code>256 Mb</code> on my <code>3Gb</code> RAM machine.</p>
  </li>
</ul>

<p><code>
-vmargs
-Xms768m
-Xmx768m
-XX:PermSize=256m
-XX:MaxPermSize=256m
</code></p>

<p>You can also add <code>-Xverify:none</code> that skips validation of loaded clases to JVM. Due to fact it skips one
step of JVM loading you will get performance boost. But it’s very risky change.</p>

<p>You can also test your eclipse performance  with different Garbage collector strategies, server options,
experimental VM options like (some of these):</p>

<p><code>
-server
-XX:+UnlockExperimentalVMOptions
-XX:+UseG1GC
-XX:+UseParallelGC
-XX:+UseFastAccessorMethods
-Xss2m
</code></p>

<p>Check all <a href="http://help.eclipse.org/indigo/index.jsp?topic=%2Forg.eclipse.platform.doc.isv%2Freference%2Fmisc%2Fruntime-options.html">Eclipse runtime options</a>
for reference and choose ones that appropriate for you.</p>

<h4 id="disable-animations">Disable animations</h4>

<p>Animations it’s cool. But I always disable animations if it possible in all tools.
Also, classic theme is most usable for me.</p>

<pre><code>Window -&gt; Preferences -&gt; General -&gt; Appearance -&gt; Uncheck 'Enable animations'
</code></pre>

<p><img src="http://i.imgur.com/mzLp7.png" alt="" /></p>

<h4 id="disable-label-decorations">Disable label decorations</h4>

<p>Label decorations are small icons on project, file, class levels that helps
visually indicate some state of file. Like commited it to git or no.
They are provided by various plugins and rarely useful. Just left ones that you want.</p>

<pre><code>Window -&gt; Preferences -&gt; General -&gt; Appearance -&gt; Label Decorations
</code></pre>

<p><img src="http://i.imgur.com/MKZp5.png" alt="" /></p>

<h4 id="autocompletion">Autocompletion</h4>

<p>Sometimes on slow machines or when you have a lot of classes in your classpath autocompletion performance is terrible.
Small improvement you can get by reducing group of possible proposals. I left only <code>Java Proposals</code> and <code>Template Proposals</code>:</p>

<pre><code>Window -&gt; Preferences -&gt; Java -&gt; Editor -&gt; Content Assist -&gt; Advanced
</code></pre>

<p><img src="http://i.imgur.com/Aa7MY.png" alt="" /></p>

<h4 id="uncheck-validators">Uncheck validators</h4>

<p>If you are sure in your competence just suspend all validators. If problem appears, you always
can identify the reason, but you save your development time.</p>

<pre><code>Window -&gt; Preferences -&gt; Validation -&gt; Suspend All Validators
</code></pre>

<p><img src="http://i.imgur.com/n1XQ2.png" alt="" /></p>

<h4 id="close-unrelated-projects">Close unrelated projects</h4>

<p>If you working in context of few projects, better to have all unrelated projects closed. They won’t appear
in index. You can manually <code>Close unrelated projects</code> in workspace. But I recommend to use <code>Working Set</code>.
You can add any number of projects to one working set, and quickly switch between different working sets
in one workspace.</p>

<pre><code>Right Click on Project -&gt; Assign Working Sets..
</code></pre>

<h4 id="close-unused-tabs-in-editor">Close unused tabs in editor</h4>

<p>Big number of tabs in editor can greatly slow down your performance. Just limit them.</p>

<pre><code>Window -&gt; Preferences -&gt; General -&gt; Editors
</code></pre>

<p>Check <code>Close editors automatically</code> and set <code>Number of opened tabs</code> to <code>10</code>.</p>

<p><img src="http://i.imgur.com/gjRd8.png" alt="" /></p>

<h4 id="disable-spell-check">Disable spell check</h4>

<p>Are you developer or what? I don’t see any reason to have <code>spell check</code> enabled.</p>

<pre><code>Window -&gt; Preferences -&gt; General -&gt; Editors -&gt; Text Editors -&gt; Spelling -&gt; Uncheck 'Enable spell checking'
</code></pre>

<h4 id="disable-autobuild">Disable autobuild</h4>

<p>Probably, you aware about when you want to build your project and when not.</p>

<pre><code>Project -&gt; Uncheck 'Build Automatically'
Window -&gt; Preferences -&gt; Java -&gt; Compiler -&gt; Building -&gt; Uncheck 'Scrub output folders when cleaning'
Window -&gt; Preferences -&gt; Java -&gt; Compiler -&gt; Building -&gt; Uncheck 'Rebuild class files modified by others'
</code></pre>

<h4 id="hotkeys">Hotkeys</h4>

<p>It is human-related advice. Even if you working in super-fast IDE and spend 10 actions to perform
single operation, your development process won’t be fast. Configure most-often used actions
to hotkeys and learn them. You will get a positive feedback after a week of usage.</p>

<pre><code>Windows -&gt; Preferences -&gt; General -&gt; Keys
</code></pre>

<p>To force myself learn all hotkeys I just disabled toolbar.</p>

<pre><code>Window -&gt; Hide Toolbar
</code></pre>

<h3 id="useful-links">Useful Links</h3>

<ul>
  <li><a href="http://wiki.eclipse.org/Eclipse.ini">http://wiki.eclipse.org/Eclipse.ini</a></li>
  <li><a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a></li>
  <li><a href="http://www.beyondlinux.com/2011/06/25/speed-up-your-eclipse-as-a-super-fast-ide/">http://www.beyondlinux.com/2011/06/25/speed-up-your-eclipse-as-a-super-fast-ide/</a></li>
  <li><a href="http://blog.normation.com/2010/05/24/optimizing-eclipse-performances/">http://blog.normation.com/2010/05/24/optimizing-eclipse-performances/</a></li>
  <li><a href="http://stackoverflow.com/questions/142357/what-are-the-best-jvm-settings-for-eclipse/1409590#1409590">http://stackoverflow.com/questions/142357/what-are-the-best-jvm-settings-for-eclipse/1409590#1409590</a></li>
</ul>

<p><strong>P.S.</strong> This article planned to be updatable, other tweaks are welcome!</p>
]]></content>
  </entry>
  
</feed>
